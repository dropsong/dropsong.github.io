<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>搜索引擎项目 | dropsong's</title><meta name="keywords" content="C++,搜索引擎"><meta name="author" content="dropsong"><meta name="copyright" content="dropsong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="并发服务器方案  	 		 	    Reactor模型（V1）Socket类：所有与套接字相关的操作都在 Socket 类中，负责套接字的创建与关闭，以及获取套接字。 InetAddress类：所有与地址相关的操作都在 InetAddress 类中，包括 ip 的获取、port 的获取，以及 struct sockadd_in 结构体的操作。 Acceptor类：所有连接相关的操作全部都封装在">
<meta property="og:type" content="article">
<meta property="og:title" content="搜索引擎项目">
<meta property="og:url" content="https://dropsong.github.io/posts/c434ad22.html">
<meta property="og:site_name" content="dropsong&#39;s">
<meta property="og:description" content="并发服务器方案  	 		 	    Reactor模型（V1）Socket类：所有与套接字相关的操作都在 Socket 类中，负责套接字的创建与关闭，以及获取套接字。 InetAddress类：所有与地址相关的操作都在 InetAddress 类中，包括 ip 的获取、port 的获取，以及 struct sockadd_in 结构体的操作。 Acceptor类：所有连接相关的操作全部都封装在">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://s2.loli.net/2024/12/15/Va3kH1ibsIZjxJE.webp">
<meta property="article:published_time" content="2024-05-31T17:57:56.000Z">
<meta property="article:modified_time" content="2024-12-15T14:18:20.409Z">
<meta property="article:author" content="dropsong">
<meta property="article:tag" content="C++">
<meta property="article:tag" content="搜索引擎">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.loli.net/2024/12/15/Va3kH1ibsIZjxJE.webp"><link rel="shortcut icon" href="/img/favicon2.jpg"><link rel="canonical" href="https://dropsong.github.io/posts/c434ad22"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '搜索引擎项目',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-12-15 22:18:20'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="dropsong's" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/07/tEWlYGuVUqFvxw7.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">149</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://s2.loli.net/2024/12/15/Va3kH1ibsIZjxJE.webp')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">dropsong's</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">搜索引擎项目</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2024-05-31T17:57:56.000Z" title="发表于 2024-06-01 01:57:56">2024-06-01</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">8.1k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h2 id="并发服务器方案"><a href="#并发服务器方案" class="headerlink" title="并发服务器方案"></a>并发服务器方案</h2>

	<div class="row">
		<iframe src="https://drive.google.com/file/d/1Nf7GqoqVR2mKDuE2_mepxiPF9bkm5JSY/preview" style="width:100%; height:550px"></iframe>
	</div>



<h2 id="Reactor模型（V1）"><a href="#Reactor模型（V1）" class="headerlink" title="Reactor模型（V1）"></a>Reactor模型（V1）</h2><p>Socket类：所有与套接字相关的操作都在 Socket 类中，负责套接字的创建与关闭，以及获取套接字。</p>
<p>InetAddress类：所有与地址相关的操作都在 InetAddress 类中，包括 ip 的获取、port 的获取，以及 struct sockadd_in 结构体的操作。</p>
<p>Acceptor类：所有连接相关的操作全部都封装在 Acceptor 中，包括：端口复用、地址复用、bind、listen、accept 操作。</p>
<p>TcpConnection类：只要 accept 函数有正确的返回值，那么就表明三次握手已经建立成功了，那么这条连接就是正常的，就可以创建这条连接。那么数据的收发都可以靠 TcpConnection 这条连接，封装收发数据的函数 send 与 receive 函数。</p>
<p>SocketIO类：是真正底层进行数据收发的类，该类进行执行系统调用 recv/send 操作，进行真正数据的收发。</p>
<p>类图：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/29/isDFSjx51to7wXH.png" alt="76-1.png"></p>
<p>代码实现：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v1">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v1</a></p>
<p>V1 主要是完成了面向对象的封装。</p>
<h2 id="Reactor模型（V2）"><a href="#Reactor模型（V2）" class="headerlink" title="Reactor模型（V2）"></a>Reactor模型（V2）</h2><p>V1 只实现了非常基础的功能，一个 server 只能服务一个 client. 现在我们尝试加入 epoll.</p>
<p>类图（初版，之后还会有变动）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/29/EjXDziNAaknh6HL.png" alt="76-2.png"></p>
<p>对应上面的类图写出伪代码：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">loop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _isLooping = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">while</span>(_isLooping)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">waitEpollFd</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">unloop</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    _isLooping = <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">waitEpollFd</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    nready = <span class="built_in">epoll_wait</span>();</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == nready &amp;&amp; errno == EINTR)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">continue</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">-1</span> == nready)</span><br><span class="line">    &#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;epoll_wait&quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0</span> == nready)</span><br><span class="line">    &#123;</span><br><span class="line">        cout &lt;&lt; <span class="string">&quot;&gt;&gt;epoll_wait timeout&quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; nready; ++idx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(有新的连接请求进来，并且是读事件)<span class="comment">//fd == listenfd</span></span><br><span class="line">            &#123;</span><br><span class="line">                <span class="built_in">handleNewConnection</span>();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                fd = _evtList[idx].data.fd;</span><br><span class="line">                <span class="comment">//老的连接上有读事件</span></span><br><span class="line">                <span class="built_in">handleMessage</span>(fd);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleNewConnection</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    connfd = _acceptor.<span class="built_in">accept</span>();</span><br><span class="line">    <span class="keyword">if</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//处理connfd的异常</span></span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="function">TcpConnection <span class="title">con</span><span class="params">(connfd)</span></span>;</span><br><span class="line">    _conns.<span class="built_in">insert</span>(connd, con);</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">addEpollReadFd</span>(connfd);</span><br><span class="line">&#125;</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">handleMessage</span><span class="params">(<span class="type">int</span> fd)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    it = _conns.<span class="built_in">find</span>(fd);</span><br><span class="line">    <span class="keyword">if</span>()</span><br><span class="line">    &#123;</span><br><span class="line">        it-&gt;<span class="built_in">send</span>();</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//接收数据</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在面向对象的代码之前，我们先看看<strong>面向过程的逻辑</strong>：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/epoll.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;arpa/inet.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;netinet/in.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cin;</span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//1. 创建监听服务器的套接字</span></span><br><span class="line">    <span class="type">int</span> listenfd = ::<span class="built_in">socket</span>(AF_INET, SOCK_STREAM, <span class="number">0</span>);	</span><br><span class="line">    <span class="keyword">if</span>(listenfd &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;socket&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//地址复用</span></span><br><span class="line">    <span class="type">int</span> opt = <span class="number">1</span>;</span><br><span class="line">    <span class="type">int</span> ret = <span class="built_in">setsockopt</span>(listenfd,  SOL_SOCKET, SO_REUSEADDR, &amp;opt, <span class="built_in">sizeof</span>(opt));</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;setsockopt ip error&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//端口重用</span></span><br><span class="line">    ret = <span class="built_in">setsockopt</span>(listenfd, SOL_SOCKET, SO_REUSEPORT, &amp;opt, <span class="built_in">sizeof</span>(opt));</span><br><span class="line">    <span class="keyword">if</span>(<span class="number">-1</span> == ret)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;setsockopt port error&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//网络地址需要采用网络字节序存储(大端模式)</span></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">sockaddr_in</span> serveraddr;</span><br><span class="line">    <span class="built_in">memset</span>(&amp;serveraddr, <span class="number">0</span>, <span class="built_in">sizeof</span>(serveraddr));</span><br><span class="line">    serveraddr.sin_family = AF_INET;</span><br><span class="line">    serveraddr.sin_port = <span class="built_in">htons</span>(<span class="number">8888</span>);</span><br><span class="line">    serveraddr.sin_addr.s_addr = <span class="built_in">inet_addr</span>(<span class="string">&quot;127.0.0.1&quot;</span>);</span><br><span class="line">    <span class="type">socklen_t</span> length = <span class="built_in">sizeof</span>(serveraddr);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 绑定服务器的网络地址</span></span><br><span class="line">    <span class="keyword">if</span>(::<span class="built_in">bind</span>(listenfd, (<span class="keyword">struct</span> sockaddr*)&amp;serveraddr, length) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;bind&quot;</span>);</span><br><span class="line">        <span class="comment">//文件描述符是比较稀缺的，所以不用的时候要回收</span></span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 让服务器开始监听</span></span><br><span class="line">    <span class="comment">// listenfd跟所有的新连接打交道</span></span><br><span class="line">    <span class="keyword">if</span>(::<span class="built_in">listen</span>(listenfd, <span class="number">128</span>) &lt; <span class="number">0</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;listen&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125; </span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;server is listening...&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 创建epoll实例</span></span><br><span class="line">    <span class="type">int</span> efd = ::<span class="built_in">epoll_create1</span>(<span class="number">0</span>);<span class="comment">// 红黑树 + 就绪链表</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">    ev.events = EPOLLIN | EPOLLOUT;</span><br><span class="line">    ev.data.fd = listenfd;</span><br><span class="line">    <span class="comment">//epoll要进行监听操作: 对listenfd的读事件进行监听</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//Reactor: 注册读就绪事件</span></span><br><span class="line">    ret = ::<span class="built_in">epoll_ctl</span>(efd, EPOLL_CTL_ADD, listenfd, &amp;ev);</span><br><span class="line">    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">        <span class="built_in">close</span>(listenfd);</span><br><span class="line">        <span class="built_in">close</span>(efd);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> *evtList = </span><br><span class="line">        (<span class="keyword">struct</span> epoll_event *)<span class="built_in">malloc</span>(<span class="number">1024</span> * <span class="built_in">sizeof</span>(<span class="keyword">struct</span> epoll_event));</span><br><span class="line"></span><br><span class="line">    <span class="comment">//事件循环</span></span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">//Reactor: 事件分离器</span></span><br><span class="line">        <span class="type">int</span> nready = ::<span class="built_in">epoll_wait</span>(efd, evtList, <span class="number">1024</span>, <span class="number">3000</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="number">-1</span> == nready &amp;&amp; errno == EINTR)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">-1</span> == nready) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">perror</span>(<span class="string">&quot;epoll_wait&quot;</span>);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span>(<span class="number">0</span> == nready) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; epoll_wait timeout!\n&quot;</span>);</span><br><span class="line">        &#125; </span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">//遍历struct epoll_event数组, 去check</span></span><br><span class="line">            <span class="comment">//每一个epoll_event到底发生了什么事件</span></span><br><span class="line">            <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">0</span>; idx &lt; nready; ++idx)</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 必须要使用按位&amp;操作来判断事件，不能使用==,&amp;&amp;</span></span><br><span class="line">                <span class="keyword">if</span>((evtList[idx].data.fd == listenfd)  &amp;&amp;</span><br><span class="line">                   (evtList[idx].events &amp; EPOLLIN)) </span><br><span class="line">                &#123;   </span><br><span class="line">                    <span class="comment">//意味着有新连接来了,所以要调用accept函数,获取新连接</span></span><br><span class="line">                    <span class="comment">//写事件什么情况会触发? 只要内核发送缓冲区还有空间，就可以触发写事件</span></span><br><span class="line">                    <span class="type">int</span> peerfd = ::<span class="built_in">accept</span>(listenfd, <span class="literal">nullptr</span>, <span class="literal">nullptr</span>);	</span><br><span class="line">                    <span class="comment">/* TcpConnection conn(peerfd); */</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">//将新连接添加到epoll的监听实例中去</span></span><br><span class="line">                    <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">                    ev.events = EPOLLIN | EPOLLOUT | EPOLLERR;</span><br><span class="line">                    ev.data.fd = peerfd;</span><br><span class="line">                    ret = ::<span class="built_in">epoll_ctl</span>(efd, EPOLL_CTL_ADD, peerfd, &amp;ev);</span><br><span class="line">                    <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) </span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="comment">//新连接到来之后的处理</span></span><br><span class="line">                    <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt; conn has connected, fd: %d\n&quot;</span>, peerfd);</span><br><span class="line">                    <span class="comment">//记录日志, 使用Log4cpp完成</span></span><br><span class="line">                    <span class="comment">//个性定制化 ==&gt; 事件处理器</span></span><br><span class="line">                    <span class="comment">/* onConnection();//考虑扩展性，挖一个坑 */</span></span><br><span class="line">                &#125; </span><br><span class="line">                <span class="keyword">else</span></span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="comment">// 已经建立好的连接发送数据过来了</span></span><br><span class="line">                    <span class="comment">// 如果发生了读事件</span></span><br><span class="line">                    <span class="type">char</span> buff[<span class="number">128</span>] = &#123;<span class="number">0</span>&#125;;</span><br><span class="line">                    <span class="keyword">if</span>(evtList[idx].events &amp; EPOLLIN)</span><br><span class="line">                    &#123;</span><br><span class="line">                        <span class="type">int</span> fd = evtList[idx].data.fd;</span><br><span class="line">                        ret = ::<span class="built_in">recv</span>(fd, buff, <span class="built_in">sizeof</span>(buff), <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">                        <span class="keyword">if</span>(ret &gt; <span class="number">0</span>) </span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; recv msg %d bytes,content:%s\n&quot;</span>,</span><br><span class="line">                                    ret, buff);</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">//1. 对应用层数据进行解析</span></span><br><span class="line">                            <span class="comment">//2. 拿到最终要处理的数据之后，进行业务逻辑处理</span></span><br><span class="line">                            <span class="comment">//(假设第2步执行的时间很长1S, 是否合适)</span></span><br><span class="line">                            <span class="comment">//3. 得到要返回给客户端的数据之后，进行发送操作</span></span><br><span class="line">                            <span class="comment">//</span></span><br><span class="line"></span><br><span class="line">                            ret = <span class="built_in">send</span>(fd, buff, <span class="built_in">strlen</span>(buff), <span class="number">0</span>);</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;&gt;&gt;&gt; send %d bytes\n&quot;</span>, ret);</span><br><span class="line">                            <span class="comment">/* onMessage();//, 考虑扩展性，挖一个坑 */</span></span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">else</span> <span class="keyword">if</span>(ret == <span class="number">0</span>)</span><br><span class="line">                        &#123;</span><br><span class="line">                            <span class="built_in">printf</span>(<span class="string">&quot;conn has closed!\n&quot;</span>);</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment">//需要从epoll的监听实例删除掉, 因为连接断开，不需要再监听了</span></span><br><span class="line">                            <span class="keyword">struct</span> <span class="title class_">epoll_event</span> ev;</span><br><span class="line">                            ev.data.fd = fd;</span><br><span class="line">                            ret = ::<span class="built_in">epoll_ctl</span>(efd, EPOLL_CTL_DEL, fd, &amp;ev);</span><br><span class="line">                            <span class="keyword">if</span>(ret &lt; <span class="number">0</span>) </span><br><span class="line">                            &#123;</span><br><span class="line">                                <span class="built_in">perror</span>(<span class="string">&quot;epoll_ctl&quot;</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//记录日志, log4cpp</span></span><br><span class="line">                            <span class="comment">/* onClose();//考虑扩展性，挖一个坑 */</span></span><br><span class="line">                        &#125;<span class="comment">// end of ret if</span></span><br><span class="line">                    &#125;<span class="comment">//end of event if</span></span><br><span class="line">                    <span class="comment">//else if()  //处理其他事件的</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="built_in">close</span>(listenfd);<span class="comment">// 关闭连接</span></span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>TCP 网络编程最本质的是处理<strong>三个半事件</strong>：</p>
<ol>
<li><strong>连接建立</strong>：包括服务器端被动接受连接（accept）和客户端主动发起连接（connect）。TCP 连接一旦建立，客户端和服务端就是平等的，可以各自收发数据。</li>
<li><strong>连接断开</strong>：包括主动断开（close、shutdown）和被动断开（read()返回 0）。</li>
<li><strong>消息到达</strong>：文件描述符可读。这是最为重要的一个事件，对它的处理方式决定了网络编程的风格（阻塞还是非阻塞，如何处理分包，应用层的缓冲如何设计等等）。</li>
<li><strong>消息发送完毕</strong>：这算半个。对于低流量的服务，可不必关心这个事件；另外，这里的“发送完毕”是指数据写入操作系统缓冲区（内核缓冲区），将由 TCP 协议栈负责数据的发送与重传，不代表对方已经接收到数据。</li>
</ol>
<p>代码：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v2">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v2</a></p>
<p>重新考虑细节之后，类图如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/05/31/AbECe43dchnG8aR.png" alt="76-3.png"></p>
<h2 id="Reactor模型（V3）"><a href="#Reactor模型（V3）" class="headerlink" title="Reactor模型（V3）"></a>Reactor模型（V3）</h2><p>为使 V2 代码的 main 函数更加简洁，我们进一步封装：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/04/HA8eiGFRnmjVIcN.png" alt="76-4.png"></p>
<p>代码（较 V2 版本改动较小）：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v3">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v3</a></p>
<p><strong>V2 和 V3 版本其实就是实现了 Basic Reactor Design .</strong></p>
<h2 id="进程、线程通信"><a href="#进程、线程通信" class="headerlink" title="进程、线程通信"></a>进程、线程通信</h2><h3 id="引入"><a href="#引入" class="headerlink" title="引入"></a>引入</h3><p>我们尝试开发 Reactor 的 V4 版本，即 Reactor with ThreadPool. 要义是将 IO 和计算任务分开。</p>
<p>将 IO 和计算任务分开的必要性：它们的速度不匹配。</p>
<p>我们改进 V3 版本的 <code>TestTcpServer.cc</code> 文件：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcpServer.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;TcpConnection.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">MyTask</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">    <span class="built_in">MyTask</span>(<span class="type">const</span> string &amp;msg, <span class="type">const</span> TcpConnectionPtr &amp;con)</span><br><span class="line">    : _msg(msg)</span><br><span class="line">    , _con(con)</span><br><span class="line">    &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">process</span><span class="params">()</span></span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">        <span class="comment">//所有的业务逻辑的处理，decode、compute、encode</span></span><br><span class="line">        <span class="comment">//在此处理msg1</span></span><br><span class="line">        _msg;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//线程池处理完毕业务逻辑之后，需要告诉Reactor/EventLoop去进行发送</span></span><br><span class="line">        <span class="comment">//数据，因为数据的收发不是线程池的功能，为了将职责分清楚，所以</span></span><br><span class="line">        <span class="comment">//Reactor/EventLoop进行IO操作，而线程池主要处理业务逻辑，也就是</span></span><br><span class="line">        <span class="comment">//进行计算操作，所以我们将IO操作的线程，称为IO线程，将计算操作的</span></span><br><span class="line">        <span class="comment">//线程，称为计算线程。</span></span><br><span class="line">        <span class="comment">//那么就会涉及到计算线程要通知IO线程进行数据的发送</span></span><br><span class="line">        <span class="comment">//那么就会涉及到线程之间的通信？</span></span><br><span class="line">        <span class="comment">//eventfd解决线程或者进程之间的通信。。。</span></span><br><span class="line">        <span class="comment">//将msg1发送数据给客户端</span></span><br><span class="line">        _con-&gt;<span class="built_in">sendInLoop</span>(_msg);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">    string _msg;</span><br><span class="line">    TcpConnectionPtr _con;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">onConnection</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;con)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; con-&gt;<span class="built_in">toString</span>() &lt;&lt; <span class="string">&quot; has connected!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;con)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收客户端的数据</span></span><br><span class="line">    <span class="comment">//接收数据，也就是read数据，也就是读数据，是EventLoop线程</span></span><br><span class="line">    <span class="comment">//也就是Reactor线程，并且数据的发送也是属于EventLoop线程</span></span><br><span class="line">    <span class="comment">//或者Reactor线程</span></span><br><span class="line">    string msg = con-&gt;<span class="built_in">receive</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&gt;&gt;recv msg from client: &quot;</span> &lt;&lt; msg &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将接收的msg，业务逻辑进行decode compute encode操作</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function">MyTask <span class="title">task</span><span class="params">(msg, con)</span></span>;</span><br><span class="line">    pool.<span class="built_in">addTask</span>(std::<span class="built_in">bind</span>(&amp;MyTask::process, task));<span class="comment">//bind的地址传递与值传递</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//msg1</span></span><br><span class="line">    <span class="comment">//将msg1发送数据给客户端</span></span><br><span class="line">    <span class="comment">/* con-&gt;send(msg); */</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">onClose</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;con)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    cout &lt;&lt; con-&gt;<span class="built_in">toString</span>() &lt;&lt; <span class="string">&quot; has closed!&quot;</span> &lt;&lt; endl;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> **argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">TcpServer <span class="title">server</span><span class="params">(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">8888</span>)</span></span>;</span><br><span class="line">    server.<span class="built_in">setAllCallback</span>(std::<span class="built_in">move</span>(onConnection)</span><br><span class="line">                          , std::<span class="built_in">move</span>(onMessage)</span><br><span class="line">                          , std::<span class="built_in">move</span>(onClose));</span><br><span class="line">    server.<span class="built_in">start</span>();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在上面的代码中，我们发现有必要了解进程、线程间的通信。</p>
<h3 id="eventfd-系统调用"><a href="#eventfd-系统调用" class="headerlink" title="eventfd 系统调用"></a>eventfd 系统调用</h3><p>从 Linux 2.6.27 版本开始，新增了不少系统调用，其中包括 eventfd，它主要用于进程或线程间通信（如通知/等待机制的实现）。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/eventfd.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">eventfd</span><span class="params">(<span class="type">unsigned</span> <span class="type">int</span> initval, <span class="type">int</span> flags)</span></span>;</span><br><span class="line"><span class="comment">//initval:64位的计数器，并且由内核维护。</span></span><br><span class="line"><span class="comment">//flags:可以设置为0.</span></span><br><span class="line"><span class="comment">//返回值：返回的是一个 eventfd 对象（可以理解为文件描述符）。</span></span><br></pre></td></tr></table></figure>
<p>eventfd 支持的操作：</p>
<ul>
<li>read</li>
<li>write</li>
<li>select / poll / epoll</li>
</ul>
<p>eventfd 是专门用于事件通知的文件描述符（fd）。它创建一个 eventfd 对象，eventfd 对象不仅可以用于进程间的通信，还能用于用户态和内核态的通信。<strong>eventfd 对象在内核中包含了一个计数器，该计数器是 64 位的无符号整数（uint64_t），计数不为零是有可读事件发生，read 之后计数会清零，write 则会递增计数器。</strong></p>
<p>看一个例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/eventfd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;stdint.h&gt;</span>             <span class="comment">/* Definition of uint64_t */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> handle_error(msg) \</span></span><br><span class="line"><span class="meta">    do &#123; perror(msg); exit(EXIT_FAILURE); &#125; while (0)</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">int</span> argc, <span class="type">char</span> *argv[])</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="type">int</span> efd, j;</span><br><span class="line">    <span class="type">uint64_t</span> u;</span><br><span class="line">    <span class="type">ssize_t</span> s;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (argc &lt; <span class="number">2</span>) </span><br><span class="line">    &#123;</span><br><span class="line">        <span class="built_in">fprintf</span>(stderr, <span class="string">&quot;Usage: %s &lt;num&gt;...\n&quot;</span>, argv[<span class="number">0</span>]);</span><br><span class="line">        <span class="built_in">exit</span>(EXIT_FAILURE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    efd = <span class="built_in">eventfd</span>(<span class="number">10</span>, <span class="number">0</span>);<span class="comment">//eventfd的第一个参数代表的是内核上的计数器</span></span><br><span class="line">    <span class="keyword">if</span> (efd == <span class="number">-1</span>)</span><br><span class="line">        <span class="built_in">handle_error</span>(<span class="string">&quot;eventfd&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (fork()) </span><br><span class="line">    &#123;</span><br><span class="line">    <span class="keyword">case</span> <span class="number">0</span>:</span><br><span class="line">        <span class="comment">//case 0部分是子线程的执行流</span></span><br><span class="line">        <span class="keyword">for</span> (j = <span class="number">1</span>; j &lt; argc; j++) </span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Child writing %s to efd\n&quot;</span>, argv[j]);</span><br><span class="line">            u = <span class="built_in">strtoull</span>(argv[j], <span class="literal">NULL</span>, <span class="number">0</span>);<span class="comment">/* strtoull() allows various bases */</span></span><br><span class="line">            s = <span class="built_in">write</span>(efd, &amp;u, <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>));<span class="comment">//write可以写多次, 每执行一次，就会执行一次加法</span></span><br><span class="line">            <span class="keyword">if</span> (s != <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>))</span><br><span class="line">                <span class="built_in">handle_error</span>(<span class="string">&quot;write&quot;</span>);</span><br><span class="line"></span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">&quot;Child completed write loop\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">//父线程的一个执行流</span></span><br><span class="line">        <span class="built_in">sleep</span>(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">2</span>; idx &lt; argc; ++idx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Parent about to read\n&quot;</span>);</span><br><span class="line">            s = <span class="built_in">read</span>(efd, &amp;u, <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>));<span class="comment">// read操作会将计数器的值清0</span></span><br><span class="line">            <span class="keyword">if</span> (s != <span class="built_in">sizeof</span>(<span class="type">uint64_t</span>))</span><br><span class="line">                <span class="built_in">handle_error</span>(<span class="string">&quot;read&quot;</span>);</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;Parent read %llu (0x%llx) from efd\n&quot;</span>,</span><br><span class="line">                    (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) u, (<span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>) u);</span><br><span class="line">            <span class="built_in">sleep</span>(<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="built_in">exit</span>(EXIT_SUCCESS);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">case</span> <span class="number">-1</span>:</span><br><span class="line">        <span class="built_in">handle_error</span>(<span class="string">&quot;fork&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">./a.out  1 2 3</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">Child writing 1 to efd</span></span><br><span class="line"><span class="comment">Child writing 2 to efd</span></span><br><span class="line"><span class="comment">Parent about to read</span></span><br><span class="line"><span class="comment">Parent read 13 (0xd) from efd</span></span><br><span class="line"><span class="comment">Child writing 3 to efd</span></span><br><span class="line"><span class="comment">Parent about to read</span></span><br><span class="line"><span class="comment">Parent read 3 (0x3) from efd</span></span><br><span class="line"><span class="comment">Child completed write loop</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h3 id="eventfd-的封装"><a href="#eventfd-的封装" class="headerlink" title="eventfd 的封装"></a>eventfd 的封装</h3><p>类图（这个 MyTask 就是 <a href="https://dropsong.github.io/posts/cb3a6d2b.html">CppNote4</a> 里面的）：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/06/02/665c7953f0a53.png" alt="76-5.png"></p>
<p>代码：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/EventFd">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/EventFd</a></p>
<h2 id="Reactor模型（V4）"><a href="#Reactor模型（V4）" class="headerlink" title="Reactor模型（V4）"></a>Reactor模型（V4）</h2><p>注意，这里我们将上一张图片里的 EventFd 类揉碎了放进 EventLoop 类中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/04/JtPQSOFhEKc6yzk.jpg" alt="76-6.jpg"></p>
<p>代码：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v4">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v4</a></p>
<p>很多注释都在代码里面。</p>
<p>注意：在 Reactor_v4 的 <code>TestTcpServer.cc</code> 代码中：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gPool-&gt;<span class="built_in">addTask</span>(std::<span class="built_in">bind</span>(&amp;MyTask::process, task));</span><br></pre></td></tr></table></figure>
<p>并没有传递 task 的地址，这与之前的介绍不一样，这是为什么呢？</p>
<p>我们实验一下，发现如果用 <code>&amp;</code> 取地址，运行时会报 core dumped. </p>
<p>这是因为 task 对象的生命周期已经结束（而且它们会分属不同的线程）：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">onMessage</span><span class="params">(<span class="type">const</span> TcpConnectionPtr &amp;con)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//接收客户端的数据</span></span><br><span class="line">    <span class="comment">//接收数据，也就是read数据，也就是读数据，是EventLoop线程</span></span><br><span class="line">    <span class="comment">//也就是Reactor线程，并且数据的发送也是属于EventLoop线程</span></span><br><span class="line">    <span class="comment">//或者Reactor线程</span></span><br><span class="line">    string msg = con-&gt;<span class="built_in">receive</span>();</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;&gt;&gt;recv msg from client: &quot;</span> &lt;&lt; msg &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//将接收的msg，业务逻辑进行decode compute encode操作</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="comment">//</span></span><br><span class="line">    <span class="function">MyTask <span class="title">task</span><span class="params">(msg, con)</span></span>;</span><br><span class="line">    gPool-&gt;<span class="built_in">addTask</span>(std::<span class="built_in">bind</span>(&amp;MyTask::process, task));<span class="comment">//bind的地址传递与值传递</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而不取地址的时候，会做一个值传递（拷贝）。</p>
<p>这是 bind() 函数本身的特性，之前只是没有提：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/04/XAaFOvniskW2qCP.png" alt="76-7.png"></p>
<h2 id="Reactor模型（V5）"><a href="#Reactor模型（V5）" class="headerlink" title="Reactor模型（V5）"></a>Reactor模型（V5）</h2><p>在 v4 模型中，还有一些不足：使用了全局变量。</p>
<p>v4 中我们之所以使用全局变量，是暂时没有什么手段处理生命周期的问题。现在我们重新考虑：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/06/05/665f3e77a1e26.jpg" alt="76-8.jpg"></p>
<p>代码如下：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v5">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/Reactor_v5</a></p>
<p>代码相较于 v4 的变动是：</p>
<ul>
<li><code>TestTcpServer.cc</code> 变为 <code>EchoServer.h</code> ，其中的封装技巧值得注意。</li>
<li>测试文件 <code>testFile.cc</code> 。</li>
</ul>
<h2 id="定时器-timerfd"><a href="#定时器-timerfd" class="headerlink" title="定时器 timerfd"></a>定时器 timerfd</h2><p>timerfd 是 Linux 提供的一个定时器接口。这个接口<strong>基于文件描述符</strong>，通过文件描述符的可读事件进行超时通知，所以能够被用于 select/poll/epoll 的应用场景。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;sys/timerfd.h&gt;</span></span></span><br><span class="line"><span class="type">int</span> <span class="title function_">timerfd_create</span><span class="params">(<span class="type">int</span> clockid, <span class="type">int</span> flags)</span>;</span><br><span class="line"><span class="comment">// clockid 可设置为：</span></span><br><span class="line"><span class="comment">//    1. CLOCK_REALTIME：从1970.1.1到目前的时间。更改系统时间 会更改获取的值，它以系统时间为坐标。</span></span><br><span class="line"><span class="comment">//    2. CLOCK_MONOTONIC：获取的时间为系统重启到现在的时间，更改系统时间对其没有影响。</span></span><br><span class="line"><span class="comment">// flags:直接传递为0</span></span><br><span class="line"><span class="comment">// 返回值：返回一个定时器对象，也就是一个文件描述符。</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">timerfd_settime</span><span class="params">(<span class="type">int</span> fd, <span class="type">int</span> flags,</span></span><br><span class="line"><span class="params">                    <span class="type">const</span> <span class="keyword">struct</span> itimerspec *new_value,</span></span><br><span class="line"><span class="params">                    <span class="keyword">struct</span> itimerspec *old_value)</span>;</span><br><span class="line"><span class="comment">//fd：就是timerfd_create成功执行后的函数返回值。</span></span><br><span class="line"><span class="comment">//flags:可以传递两种值，0表示是相对定时器,TFD_TIMER_ABSTIME表示是绝对定时器</span></span><br><span class="line"><span class="comment">//new_value:设置超时时间，包括开始的时间与周期时间。如果该值是0，表明定时器取消</span></span><br><span class="line"><span class="comment">//old_value:一般设置为nullptr</span></span><br><span class="line"><span class="comment">//返回值：该函数的目的就是为了去设置或者停止定时器。</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">timespec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="type">time_t</span>  tv_sec;   <span class="comment">/* Seconds */</span></span><br><span class="line">    <span class="type">long</span>    tv_nsec;  <span class="comment">/* Nanoseconds */</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">itimerspec</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">it_interval</span>;</span> <span class="comment">/* Interval for periodic timer */</span>  <span class="comment">//周期时间</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">timespec</span> <span class="title">it_value</span>;</span>    <span class="comment">/* Initial expiration */</span>  <span class="comment">//初始时间</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>考虑封装其功能如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/04/KbONdS8yQWa6LsR.png" alt="76-9.png"></p>
<p>代码：<br><a target="_blank" rel="noopener" href="https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/TimerFd">https://github.com/dropsong/CPP_Code_Eaxmple/tree/master/TimerFd</a></p>
<p>TimerFd 自然也可以用在 Reactor 的代码中，只不过未必好。</p>
<p>eventfd 与 timerfd 都可以用于线程间通信。eventfd 是让 A 线程主动唤醒 B 线程进行操作，而 timerfd 是让 B 线程被定时唤醒。</p>
<h2 id="最短编辑距离"><a href="#最短编辑距离" class="headerlink" title="最短编辑距离"></a>最短编辑距离</h2><h3 id="算法原理"><a href="#算法原理" class="headerlink" title="算法原理"></a>算法原理</h3><p>本节内容参考： <a target="_blank" rel="noopener" href="https://jozeou.github.io/2019/05/09/nlp-course-notes/nlp-note3/">NLP 笔记（三）：最短编辑距离</a></p>
<p>首先引入提出算法的动机。</p>
<p>1）如何衡量两个字符串有多相似？例如，我们需要实现<strong>拼写纠正</strong>：用户键入“graffe”，以下哪个最接近？</p>
<ul>
<li>graf</li>
<li>graft</li>
<li>grail</li>
<li>giraffe</li>
</ul>
<p>2）计算生物学：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/JozeOu/blog-images/master/nlp-course-notes/3-1.png" alt="76-10"></p>
<p><strong>编辑距离（Edit Distance）</strong>：两个字符串之间的最短编辑距离是指将一个字符串变换为另一个需要的编辑操作（插入（Insertion），删除（Deletion），替换（Substitution））的最小数量。</p>
<p>例如：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/JozeOu/blog-images/master/nlp-course-notes/3-2.png" alt="76-11"></p>
<p>注意：</p>
<ul>
<li>如果每个操作的代价值为 1，则此两个字符串之间的距离为 5</li>
<li>如果替换操作的代价值为 2，则距离为 8</li>
</ul>
<p>该问题可以动态规划求解。</p>
<p>现有长为 n 的字符串 X，长为 m 的字符串 Y .</p>
<p>定义： <code>D(i, j)</code> 为 <code>X[1...i]</code>（X 的前 i 个字符）和 <code>Y[1...j]</code>（Y 的前 j 个字符）的最短编辑距离。</p>
<p><strong>注意：这里下标是从 1 开始的。</strong></p>
<p>那么我们所求的就是 D(n, m) .</p>
<p>边界条件： <code>D(i, 0) = i</code>，<code>D(0, j) = j</code> .</p>
<p>对边界条件的解释：<br>若有一字符串为空串，则另一字符串编辑为空串的方法为 del / ins 其自身长度的字符，即该操作的代价为自身长度。</p>
<p>递推公式（替换操作代价为2）：</p>
<script type="math/tex; mode=display">D(i,j) = \min \begin{cases}
D(i-1, j)+1 & \text {} \\
D(i, j-1)+1 &\text{} \\
D(i-1, j-1)+ \begin{cases}
2 & X_i \neq Y_j \\
0 & X_i = Y_j
\end{cases} 
\end{cases}</script><p>递推公式（替换操作代价为1）：</p>
<script type="math/tex; mode=display">D(i,j) = \min \begin{cases}
D(i-1, j)+1 & \text {} \\
D(i, j-1)+1 &\text{} \\
D(i-1, j-1)+ \begin{cases}
1 & X_i \neq Y_j \\
0 & X_i = Y_j
\end{cases} 
\end{cases}</script><p>对递推公式的解释，一图胜千言：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/08/SjGm7Bxe2ZoWIcw.jpg" alt="76-12.jpeg"></p>
<p>对应的 leetcode 题目： <a target="_blank" rel="noopener" href="https://leetcode.com/problems/edit-distance/description/">edit-distance</a></p>
<p>到这里的原理已经足够我们应用了，但是我们继续拓展一下。</p>
<p><strong>计算对齐（Computing alignments）</strong>：我们经常需要将两个字符串的每个字符彼此对齐，这可以通过保持“回溯（backtrace）”来做到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/JozeOu/blog-images/master/nlp-course-notes/3-6.png" alt="76-13"></p>
<p>根据上图回溯，得到两个字符串和它们之间的对齐，见图 76-11.</p>
<p>一点微小的技巧：<code>*</code>填充在 76-11 上面还是下面取决与 76-13 黑线是横着走还是竖着走。</p>
<p><strong>加权最短编辑距离</strong>：嗯，就是加个权。</p>
<p>为什么要在计算中加权？</p>
<ul>
<li>拼写纠正：有些字母比其他字母更容易输入错</li>
<li>生物学：某些类型的删除或插入更有可能发生</li>
</ul>
<p>算法实现：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://raw.githubusercontent.com/JozeOu/blog-images/master/nlp-course-notes/3-8.png" alt="76-14"></p>
<h3 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h3><p>作为搜索引擎功能的很小一部分，我们试图实现一个中英文混合的最小编辑距离算法。</p>
<p>UTF8 编码规则：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/09/FNCdYOqDps37rwo.png" alt="76-15.png"></p>
<p>于是，可以写出如下函数求一个字符在 UTF-8 编码中占据的字节数：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">nBytesCode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ch &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>))  <span class="comment">// 检查最高位是否为1</span></span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nBytes = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">0</span>; idx != <span class="number">6</span>; ++idx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(ch &amp; (<span class="number">1</span> &lt;&lt; (<span class="number">6</span> - idx)))  <span class="comment">// 检查从第二位开始的连续1的数量</span></span><br><span class="line">            &#123;</span><br><span class="line">                ++nBytes;  </span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nBytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上，下面这份代码不仅支持中英文混合，只要是 UTF-8 就行：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::cout;</span><br><span class="line"><span class="keyword">using</span> std::endl;</span><br><span class="line"><span class="keyword">using</span> std::string;</span><br><span class="line">  </span><br><span class="line"><span class="comment">//1. 求取一个字符占据的字节数</span></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">nBytesCode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ch)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//2. 求取一个字符串的字符长度</span></span><br><span class="line"><span class="function">std::<span class="type">size_t</span> <span class="title">length</span><span class="params">(<span class="type">const</span> std::string &amp;str)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">//3. 中英文通用的最小编辑距离算法</span></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">editDistance</span><span class="params">(<span class="type">const</span> std::string &amp; lhs, <span class="type">const</span> std::string &amp;rhs)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">test0</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="comment">//std::string本身是一个字节流的字符串</span></span><br><span class="line">    <span class="comment">// 字符流的字符串</span></span><br><span class="line">    string s1 = <span class="string">&quot;abcd&quot;</span>;<span class="comment">//4个字符的字符串</span></span><br><span class="line">    <span class="comment">//获取的是字符的长度</span></span><br><span class="line">    string s2 = <span class="string">&quot;中国&quot;</span>;<span class="comment">//2个字符的字符串</span></span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">auto</span> &amp; ch : s2) &#123;</span><br><span class="line">        cout &lt;&lt; ch;</span><br><span class="line">    &#125;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s2[1]: &quot;</span> &lt;&lt; s2[<span class="number">1</span>] &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s1.size() : &quot;</span> &lt;&lt; s1.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s2.size() : &quot;</span> &lt;&lt; s2.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    string s3 = s2.<span class="built_in">substr</span>(<span class="number">0</span>, <span class="number">3</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s3.size(): &quot;</span> &lt;&lt; s3.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s3: &quot;</span> &lt;&lt; s3 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    string s4 = s2.<span class="built_in">substr</span>(<span class="number">1</span>, <span class="number">3</span>);</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s4.size(): &quot;</span> &lt;&lt; s4.<span class="built_in">size</span>() &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s4: &quot;</span> &lt;&lt; s4 &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//字符的长度</span></span><br><span class="line">    string s5 = <span class="string">&quot;abc中国&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s5.size(): &quot;</span> &lt;&lt; s5.<span class="built_in">size</span>() &lt;&lt; endl;	</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s5.length: &quot;</span> &lt;&lt; <span class="built_in">length</span>(s5) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s2与s5的最小编辑距离: &quot;</span> &lt;&lt; <span class="built_in">editDistance</span>(s2, s5) &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">    string s6 = <span class="string">&quot;今夜は月が綺麗ですね&quot;</span>;</span><br><span class="line">    string s7 = <span class="string">&quot;今夜月綺麗，有道理&quot;</span>;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s6.size(): &quot;</span> &lt;&lt; s6.<span class="built_in">size</span>() &lt;&lt; endl;	</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s6.length: &quot;</span> &lt;&lt; <span class="built_in">length</span>(s6) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s7.size(): &quot;</span> &lt;&lt; s7.<span class="built_in">size</span>() &lt;&lt; endl;	</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s7.length: &quot;</span> &lt;&lt; <span class="built_in">length</span>(s7) &lt;&lt; endl;</span><br><span class="line">    cout &lt;&lt; <span class="string">&quot;s6与s7的最小编辑距离: &quot;</span> &lt;&lt; <span class="built_in">editDistance</span>(s6, s7) &lt;&lt; endl;</span><br><span class="line">    <span class="comment">// 注意替换的代价是 1</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">(<span class="type">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="built_in">test0</span>();</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">size_t</span> <span class="title">nBytesCode</span><span class="params">(<span class="type">const</span> <span class="type">char</span> ch)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(ch &amp; (<span class="number">1</span> &lt;&lt; <span class="number">7</span>))</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nBytes = <span class="number">1</span>;</span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> idx = <span class="number">0</span>; idx != <span class="number">6</span>; ++idx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="keyword">if</span>(ch &amp; (<span class="number">1</span> &lt;&lt; (<span class="number">6</span> - idx)))</span><br><span class="line">            &#123;</span><br><span class="line">                ++nBytes;	</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> nBytes;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;  </span><br><span class="line">  </span><br><span class="line"><span class="comment">// 看穿内存的操作（</span></span><br><span class="line"><span class="function">std::<span class="type">size_t</span> <span class="title">length</span><span class="params">(<span class="type">const</span> std::string &amp;str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    std::<span class="type">size_t</span> ilen = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">for</span>(std::<span class="type">size_t</span> idx = <span class="number">0</span>; idx != str.<span class="built_in">size</span>(); ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="type">int</span> nBytes = <span class="built_in">nBytesCode</span>(str[idx]);</span><br><span class="line">        <span class="comment">// 如果这个字符不止一个字节，就跳到它的最后一个字节</span></span><br><span class="line">        idx += (nBytes - <span class="number">1</span>);</span><br><span class="line">        ++ilen;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> ilen;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">triple_min</span><span class="params">(<span class="type">const</span> <span class="type">int</span> &amp;a, <span class="type">const</span> <span class="type">int</span> &amp;b, <span class="type">const</span> <span class="type">int</span> &amp;c)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> a &lt; b ? (a &lt; c ? a : c) : (b &lt; c ? b : c);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">editDistance</span><span class="params">(<span class="type">const</span> std::string &amp; lhs, <span class="type">const</span> std::string &amp;rhs)</span></span></span><br><span class="line"><span class="function"></span>&#123;<span class="comment">//计算最小编辑距离-包括处理中英文</span></span><br><span class="line"></span><br><span class="line">    <span class="type">size_t</span> lhs_len = <span class="built_in">length</span>(lhs);</span><br><span class="line">    <span class="type">size_t</span> rhs_len = <span class="built_in">length</span>(rhs);</span><br><span class="line">    <span class="type">int</span> editDist[lhs_len + <span class="number">1</span>][rhs_len + <span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> idx = <span class="number">0</span>; idx &lt;= lhs_len; ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        editDist[idx][<span class="number">0</span>] = idx;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">size_t</span> idx = <span class="number">0</span>; idx &lt;= rhs_len; ++idx)</span><br><span class="line">    &#123;</span><br><span class="line">        editDist[<span class="number">0</span>][idx] = idx;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    std::string sublhs, subrhs;</span><br><span class="line">    <span class="keyword">for</span>(std::<span class="type">size_t</span> dist_i = <span class="number">1</span>, lhs_idx = <span class="number">0</span>; dist_i &lt;= lhs_len; ++dist_i, ++lhs_idx)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="comment">// start string</span></span><br><span class="line">        <span class="type">size_t</span> nBytes = <span class="built_in">nBytesCode</span>(lhs[lhs_idx]);</span><br><span class="line">        sublhs = lhs.<span class="built_in">substr</span>(lhs_idx, nBytes);</span><br><span class="line">        lhs_idx += (nBytes - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span>(std::<span class="type">size_t</span> dist_j = <span class="number">1</span>, rhs_idx = <span class="number">0</span>; dist_j &lt;= rhs_len; ++dist_j, ++rhs_idx)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// target string</span></span><br><span class="line">            nBytes = <span class="built_in">nBytesCode</span>(rhs[rhs_idx]);</span><br><span class="line">            subrhs = rhs.<span class="built_in">substr</span>(rhs_idx, nBytes);</span><br><span class="line">            rhs_idx += (nBytes - <span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(sublhs == subrhs)</span><br><span class="line">            &#123;</span><br><span class="line">                editDist[dist_i][dist_j] = editDist[dist_i - <span class="number">1</span>][dist_j - <span class="number">1</span>];</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span></span><br><span class="line">            &#123;</span><br><span class="line">                editDist[dist_i][dist_j] = <span class="built_in">triple_min</span>(</span><br><span class="line">                    editDist[dist_i][dist_j - <span class="number">1</span>] + <span class="number">1</span>,</span><br><span class="line">                    editDist[dist_i - <span class="number">1</span>][dist_j] + <span class="number">1</span>,</span><br><span class="line">                    editDist[dist_i - <span class="number">1</span>][dist_j - <span class="number">1</span>] + <span class="number">1</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> editDist[lhs_len][rhs_len];</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">中国</span></span><br><span class="line"><span class="comment">s2[1]: �</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">s1.size() : 4</span></span><br><span class="line"><span class="comment">s2.size() : 6</span></span><br><span class="line"><span class="comment">s3.size(): 3</span></span><br><span class="line"><span class="comment">s3: 中</span></span><br><span class="line"><span class="comment">s4.size(): 3</span></span><br><span class="line"><span class="comment">s4: ���</span></span><br><span class="line"><span class="comment">s5.size(): 9</span></span><br><span class="line"><span class="comment">s5.length: 5</span></span><br><span class="line"><span class="comment">s2与s5的最小编辑距离: 3</span></span><br><span class="line"><span class="comment">s6.size(): 30</span></span><br><span class="line"><span class="comment">s6.length: 10</span></span><br><span class="line"><span class="comment">s7.size(): 27</span></span><br><span class="line"><span class="comment">s7.length: 9</span></span><br><span class="line"><span class="comment">s6与s7的最小编辑距离: 6</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>
<h2 id="Stop-words"><a href="#Stop-words" class="headerlink" title="Stop words"></a>Stop words</h2><p>本节内容转载自： <a target="_blank" rel="noopener" href="https://kavita-ganesan.com/what-are-stop-words/">What are Stop Words?</a></p>
<h3 id="What-are-Stop-Words"><a href="#What-are-Stop-Words" class="headerlink" title="What are Stop Words"></a>What are Stop Words</h3><p>When working with text mining applications, we often hear of the term “stop words” or “stop word list” or even “stop list”. Stop words are basically a set of commonly used words in any language, not just English.</p>
<p>The reason why stop words are critical to many applications is that, if we remove the words that are very commonly used in a given language, we can focus on the important words instead. For example, in the context of a search engine, if your search query is “how to develop information retrieval applications”, If the search engine tries to find web pages that contained the terms “how”, “to” “develop”, “information”, ”retrieval”, “applications” the search engine is going to find a lot more pages that contain the terms “how”, “to” than pages that contain information about developing information retrieval applications because the terms “how” and “to” are so commonly used in the English language. If we disregard these two terms, the search engine can actually focus on retrieving pages that contain the keywords: “develop” “information” “retrieval” “applications” – which would bring up pages that are actually of interest. This is just the basic intuition for using stop words.</p>
<p>Stop words can be used in a whole range of tasks and here are a few:</p>
<ol>
<li>Supervised machine learning – removing stop words from the feature space</li>
<li>Clustering – removing stop words prior to generating clusters</li>
<li>Information retrieval – preventing stop words from being indexed</li>
<li>Text summarization- excluding stop words from contributing to summarization scores &amp; removing stop words when computing ROUGE scores</li>
</ol>
<h3 id="Types-of-Stop-Words"><a href="#Types-of-Stop-Words" class="headerlink" title="Types of Stop Words"></a>Types of Stop Words</h3><p>Stop words are generally thought to be a “single set of words”. It really can mean different things to different applications. For example, in some applications removing all stop words right from determiners (e.g. the, a, an) to prepositions (e.g. above, across, before) to some adjectives (e.g. good, nice) can be an appropriate stop word list. To some applications however, this can be detrimental. For instance, in sentiment analysis removing adjective terms such as ‘good’ and ‘nice’ as well as negations such as ‘not’ can throw algorithms off their tracks. In such cases, one can choose to use a minimal stop list consisting of just determiners or determiners with prepositions or just coordinating conjunctions depending on the needs of the application.Examples of minimal stop word lists that you can use:</p>
<ol>
<li><strong>Determiners</strong> – Determiners tend to mark nouns where a determiner usually will be followed by a noun<br>examples: the, a, an, another</li>
<li><strong>Coordinating conjunctions</strong> – Coordinating conjunctions connect words, phrases, and clauses<br>examples: for, an, nor, but, or, yet, so</li>
<li><strong>Prepositions</strong> – Prepositions express temporal or spatial relations<br>examples: in, under, towards, before</li>
</ol>
<p>In some domain specific cases, such as clinical texts, we may want a whole different set of stop words. For example, terms like “mcg” “dr” and “patient” may have less discriminating power in building intelligent applications compared to terms such as ‘heart’ ‘failure’ and ‘diabetes’. In such cases, we can also construct domain specific stop words as opposed to using a published stop word list.</p>
<h3 id="应用-1"><a href="#应用-1" class="headerlink" title="应用"></a>应用</h3><p>对于我们的应用而言，上面的介绍已经足够了，更进一步的了解，在转载文章中查看。</p>
<p>这个 stop words list 可以上网找一个合适的，亦可自己制作（？）。</p>
<h2 id="boost-regex"><a href="#boost-regex" class="headerlink" title="boost::regex"></a>boost::regex</h2><p>项目会用到 boost::regex 库，标准库的实现有 bug (截至 12.2.0)，而 boost::regex 可以正常处理。</p>
<p>在 Ubuntu/Debian 上安装：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libboost-regex-dev</span><br></pre></td></tr></table></figure>
<p>一个例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/regex.hpp&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 示例文本</span></span><br><span class="line">    std::string text = <span class="string">&quot;&lt;description&gt;This is a description.&lt;/description&gt;\n&lt;content&gt;This is the\ncontent with new lines.&lt;/content&gt;&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义正则表达式</span></span><br><span class="line">    <span class="function">boost::regex <span class="title">re_description</span><span class="params">(<span class="string">&quot;&lt;description&gt;([\\s\\S]*?)&lt;/description&gt;&quot;</span>)</span></span>;</span><br><span class="line">    <span class="function">boost::regex <span class="title">re_content</span><span class="params">(<span class="string">&quot;&lt;content&gt;([\\s\\S]*?)&lt;/content&gt;&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义匹配结果存储对象</span></span><br><span class="line">    boost::smatch match_description;</span><br><span class="line">    boost::smatch match_content;</span><br><span class="line">    std::string description;</span><br><span class="line">    std::string content;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配 &lt;description&gt; 标签的内容</span></span><br><span class="line">    <span class="keyword">if</span> (boost::<span class="built_in">regex_search</span>(text, match_description, re_description)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (match_description.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            description = match_description[<span class="number">1</span>].<span class="built_in">str</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Description 内容: &quot;</span> &lt;&lt; description &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;没有匹配到 &lt;description&gt; 内容。&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 匹配 &lt;content&gt; 标签的内容</span></span><br><span class="line">    <span class="keyword">if</span> (boost::<span class="built_in">regex_search</span>(text, match_content, re_content)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (match_content.<span class="built_in">size</span>() &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            content = match_content[<span class="number">1</span>].<span class="built_in">str</span>();</span><br><span class="line">            std::cout &lt;&lt; <span class="string">&quot;Content 内容: &quot;</span> &lt;&lt; content &lt;&lt; std::endl;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;没有匹配到 &lt;content&gt; 内容。&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>编译时需要编译选项：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">g++ 你的代码.cc -lboost_regex</span><br></pre></td></tr></table></figure>
<p>另一个使用 boost::regex 的例子：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;string&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;boost/regex.hpp&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">std::string <span class="title">findSentenceWithKeyword</span><span class="params">(<span class="type">const</span> std::string&amp; content, <span class="type">const</span> std::string&amp; keyword)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// 构建正则表达式</span></span><br><span class="line">    std::string regexPattern = <span class="string">&quot;(.&#123;0,13&#125;)(&quot;</span> + keyword + <span class="string">&quot;)(.&#123;0,13&#125;)&quot;</span>;</span><br><span class="line">    <span class="function">boost::regex <span class="title">pattern</span><span class="params">(regexPattern)</span></span>;</span><br><span class="line"></span><br><span class="line">    boost::smatch match;</span><br><span class="line">    <span class="keyword">if</span> (boost::<span class="built_in">regex_search</span>(content, match, pattern)) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;...&quot;</span> + match.<span class="built_in">str</span>(<span class="number">1</span>) + match.<span class="built_in">str</span>(<span class="number">2</span>) + match.<span class="built_in">str</span>(<span class="number">3</span>) + <span class="string">&quot;...&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    std::string content = <span class="string">&quot;这是一个简单的例子，内容中包含了一个关键字。The keyword is important. 关键字非常重要。&quot;</span>;</span><br><span class="line">    std::string keyword = <span class="string">&quot;keyword&quot;</span>;</span><br><span class="line"></span><br><span class="line">    std::string result = <span class="built_in">findSentenceWithKeyword</span>(content, keyword);</span><br><span class="line">    <span class="keyword">if</span> (!result.<span class="built_in">empty</span>()) &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Found sentence: &quot;</span> &lt;&lt; result &lt;&lt; std::endl;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        std::cout &lt;&lt; <span class="string">&quot;Keyword not found in the content.&quot;</span> &lt;&lt; std::endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="思路草图"><a href="#思路草图" class="headerlink" title="思路草图"></a>思路草图</h2><p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/25/eopr7gisfPCuYF9.jpg" alt="76-16.jpg"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/25/a2ICjyQnEvHs1ZJ.jpg" alt="76-17.jpg"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/06/25/yT2xuPg5tkW7N4J.jpg" alt="76-18.jpg"></p>
<h2 id="离线部分"><a href="#离线部分" class="headerlink" title="离线部分"></a>离线部分</h2><p>词频统计、编制索引不提。值得注意的是处理中文时会需要：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">string <span class="title">trim</span><span class="params">(<span class="type">const</span> string&amp; str)</span> </span>&#123;</span><br><span class="line">    <span class="type">size_t</span> first = str.<span class="built_in">find_first_not_of</span>(<span class="string">&quot; \n\r\t&quot;</span>);</span><br><span class="line">    <span class="type">size_t</span> last = str.<span class="built_in">find_last_not_of</span>(<span class="string">&quot; \n\r\t&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> (first == string::npos || last == string::npos) ? <span class="string">&quot;&quot;</span> : str.<span class="built_in">substr</span>(first, last - first + <span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在编制网页库时，需要根据不同的 xml 文件格式编写一些特别处理的代码，有点麻烦。时不时遇到 core dump ，这大概是指针空了，需要 gdb 看看哪里出了问题，有的时候还需要深入到 xml 文件里看看，这大概率是这个 xml 文件写的很飘。</p>
<p>另外，编制网页库时还会需要 Simhash 去重，直接使用别人的代码：<a target="_blank" rel="noopener" href="https://github.com/yanyiwu/simhash">yanyiwu/simhash</a> 。关于 Simhash 的原理（若下面这个链接挂了，可以去 <a target="_blank" rel="noopener" href="https://archive.ph/">https://archive.ph/</a> 查找）：</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/maybe2030/p/5203186.html">https://www.cnblogs.com/maybe2030/p/5203186.html</a></p>
<p>接着是编写偏移库，会用到 <code>tellg()</code> 之类的函数。</p>
<p>最后编写倒排索引，使用 TF-IDF 算法。</p>
<p>该算法的目标是：</p>
<ul>
<li>某词在文档中的出现次数越多，权重越大</li>
<li>在整个网页库中的出现次数越多，权重越小</li>
</ul>
<p>定义：<br>$TF:$  Term Frequency 某个词在文章中出现的次数<br>$DF:$ Document Frequency 包含该词语的文档数量<br>$IDF:$ Inverse Document Frequency<br>$N: $ 文档的总数</p>
<script type="math/tex; mode=display">IDF = \log _2(N/(DF+1))</script><p>词语的权重为：</p>
<script type="math/tex; mode=display">w = TF \cdot IDF</script><p>一篇文档包含多个词语，其权重为 w1, w2, …, wn，对这些权重系数归一化：</p>
<script type="math/tex; mode=display">w^{'}_i = \frac{w_i}{\sqrt{\sum_{k=1}^{n} w^2_k}}</script><h2 id="在线部分"><a href="#在线部分" class="headerlink" title="在线部分"></a>在线部分</h2><p>首先，我们已经有了 Reactor 模型（V5）的代码，直接把它拿过来，就是一个 echo 服务器，添加业务逻辑的代码，就可以是想要的 SearchEngine server 代码了。</p>
<p>业务逻辑有两块，关键词推荐和网页搜索。server 要怎么知道 client 发过来的请求是关键字推荐还是网页搜索呢？可见，我们需要定义消息的格式。简单起见，消息分为如下两种：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">1 somemsg   # 关键字推荐，somemsg 为具体内容</span><br><span class="line">2 somemsg   # 网页搜索</span><br><span class="line"># 其他格式，服务器应该返回 &quot;format error !&quot;</span><br></pre></td></tr></table></figure>
<h3 id="关键字推荐"><a href="#关键字推荐" class="headerlink" title="关键字推荐"></a>关键字推荐</h3><p>关键字搜索应该怎么做呢？</p>
<p>我们先额外考虑一下缓存的情况。如果 client 发过来的查询已经在缓存中，直接将缓存中的数据取出。若不在缓存中，走完流程后还需要将这次查询和查询的结果保存在缓存中。</p>
<p>纯英文的情况，比如“hello”，我们可以把字符串拆开，<code>h</code> <code>e</code> <code>l</code> <code>o</code> ，对于每一个字符，在索引库（索引是词频库的索引）里面查找其对应的集合，得到包含这个字母的单词在词频库里面的行号。对这些集合取并集。</p>
<p>为什么是并集呢？因为我们要求的是与 hello 相似的单词，这允许出现这四个字母以外的字母。我们可以先取并集得到一个很大的集合（里面是词频库的行号），然后根据这个行号得到具体的单词和频率。这样得到的单词至少有一个字母和 hello 相同（打倒一大片，拾取一小撮）。</p>
<p>我们仍然要求得到的结果和 hello 有些相似，相似程度由最短编辑距离衡量。过滤掉相似度不足的单词（不妨设编辑距离大于 3 就认为不相似），剩下的就是合法的单词和词频。我们会得到如下的数据：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;单词, dist(编辑距离), freq(词频)&#125;</span><br></pre></td></tr></table></figure>
<p>这种形式的数据可能很多，而我们只需要五六个就差不多了。为此需要评价到底哪个单词更好，我们可以将这种形式的数据放在 struct 中，然后定义 <code>&lt;</code> : </p>
<ol>
<li>dist 小的更相似。这符合直觉。</li>
<li>dist 相同的情况下，freq 越大，就提高该单词的优先级。</li>
</ol>
<p>定义了结构体的比较方法之后，就可以把这些数据放在优先队列中，这样取数据的时候只要 pop 一定数量的元素即可。</p>
<p>那么，中文的情况呢？其实也是一样的做法。</p>
<p>中英文混合推荐呢？将中文和英文分开，分别做一遍中文和英文的关键字推荐流程即可。</p>
<h3 id="网页搜索"><a href="#网页搜索" class="headerlink" title="网页搜索"></a>网页搜索</h3><p>同样先考虑一下缓存的情况。</p>
<p>我们如法炮制，按照关键字推荐的方法做缓存，这样会有什么问题呢？</p>
<p>假设我们有两条查询：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1 cat</span><br><span class="line">2 cat</span><br></pre></td></tr></table></figure>
<p>因为我们将数据放在缓存中的时候，是将 cat 和对应的结果放进去的，这样没法区分开。我们改变放入缓存的策略：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;useRedis.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;myRedis.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&lt;memory&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> std::unique_ptr;</span><br><span class="line"></span><br><span class="line"><span class="function">string <span class="title">findInCache</span><span class="params">(<span class="type">const</span> string&amp; A, string flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;MyRedis&gt; <span class="title">pRedis</span><span class="params">(<span class="keyword">new</span> MyRedis())</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(!pRedis-&gt;<span class="built_in">connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>))&#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect error ! &quot;</span> &lt;&lt; endl;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> pRedis-&gt;<span class="built_in">get</span>(<span class="string">&quot;flAg&quot;</span>+flag+<span class="string">&quot;xD&quot;</span>+A);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">putInCache</span><span class="params">(<span class="type">const</span> string&amp; A, <span class="type">const</span> string&amp; B, string flag)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="function">unique_ptr&lt;MyRedis&gt; <span class="title">pRedis</span><span class="params">(<span class="keyword">new</span> MyRedis())</span></span>;</span><br><span class="line">    <span class="keyword">if</span>(!pRedis-&gt;<span class="built_in">connect</span>(<span class="string">&quot;127.0.0.1&quot;</span>, <span class="number">6379</span>))&#123;</span><br><span class="line">        cerr &lt;&lt; <span class="string">&quot;connect error ! &quot;</span> &lt;&lt; endl;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    pRedis-&gt;<span class="built_in">set</span>(<span class="string">&quot;flAg&quot;</span>+flag+<span class="string">&quot;xD&quot;</span>+A, B);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>处理查询请求时，对于 client 发来的搜索词，将它们视为一篇文档 X，计算出每个关键词的权重系数，这就要先进行 jieba 分词。</p>
<p>此处的权重系数，并不能完全按照 TF-IDF 算法。因为这里词语的权重仅是在该查询语句中的权重，计算词频 Wi 即可，然后归一化：</p>
<script type="math/tex; mode=display">W_i^{'} = \frac{W_i}{\sqrt{\sum W_k^2}}</script><p>将其组成一个向量(w1, w2, …,wn)，该向量作为基准向量 Base .</p>
<p>通过倒排索引表查找包含所有关键字的网页，只要其中有一个查询词不在索引表中，就认为没有找到相关的网页。在这个过程中，不仅要把一个个词语对应的 docid 放在放在 <code>vector&lt;set&lt;int&gt;&gt;</code> 中，还要将某个 docid 里某个分词的 TF-IDF 权重放在 <code>map&lt;pair&lt;int, string&gt;, double&gt;</code> 中。</p>
<p>将得到的 set 取交集，对于每一篇文章，计算它与 base 的余弦相似度。</p>
<p>将搜索结果填充标题、链接、摘要，并按余弦相似度排序。</p>
<p>如何生成摘要信息？见 boost::regex 部分的代码。</p>
<h2 id="后日谈"><a href="#后日谈" class="headerlink" title="后日谈"></a>后日谈</h2><p>没什么可谈的。</p>
<p>代码链接：见 github 仓库。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://dropsong.github.io">dropsong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dropsong.github.io/posts/c434ad22.html">https://dropsong.github.io/posts/c434ad22.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dropsong.github.io" target="_blank">dropsong's</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/C/">C++</a><a class="post-meta__tags" href="/tags/%E6%90%9C%E7%B4%A2%E5%BC%95%E6%93%8E/">搜索引擎</a></div><div class="post_share"><div class="social-share" data-image="https://s2.loli.net/2024/12/15/Va3kH1ibsIZjxJE.webp" data-sites="facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://sway.office.com/s/earvb0OKBw38frLT/images/MlKmiZMe5C5Gf5" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sway.office.com/s/earvb0OKBw38frLT/images/MlKmiZMe5C5Gf5" alt="Thanks ᗜ ‸ ᗜ"/></a><div class="post-qr-code-desc">Thanks ᗜ ‸ ᗜ</div></li><li class="reward-item"><a href="https://sway.office.com/s/C4drow041G0kHpIc/images/tO2U2uk1DoetkI" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sway.office.com/s/C4drow041G0kHpIc/images/tO2U2uk1DoetkI" alt="₍ᐢ.ˬ.⑅ᐢ₎"/></a><div class="post-qr-code-desc">₍ᐢ.ˬ.⑅ᐢ₎</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/1b848c05.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://steamuserimages-a.akamaihd.net/ugc/2083534998830103087/2704E533657F02DE764E246534A8D921EADC127E/" onerror="onerror=null;src='/img/404me.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">sonny boy</div></div></a></div><div class="next-post pull-right"><a href="/posts/85db1ce6.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/12/15/ts9la2NqvZFAQc8.webp" onerror="onerror=null;src='/img/404me.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">高中物理讲义</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2249c81f.html" title="CppNote2"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/01/09/DbQ89pAl7aKuOFU.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-01-09</div><div class="title">CppNote2</div></div></a></div><div><a href="/posts/3bc8141e.html" title="游戏引擎 toybox"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/04/24/6629182541f7f.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-04-24</div><div class="title">游戏引擎 toybox</div></div></a></div><div><a href="/posts/555ef888.html" title="CppNote3"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/02/20/KYpVrkgNBtxC5nu.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-20</div><div class="title">CppNote3</div></div></a></div><div><a href="/posts/cb3a6d2b.html" title="CppNote4"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2024/04/22/273994722/6d08d91ce74a04c4de9faf2d4d7c5c39_5090351217895417007.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-05-03</div><div class="title">CppNote4</div></div></a></div><div><a href="/posts/54b4d7a2.html" title="CppNote"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2022/11/12/mEVKFN5BO7g6yPM.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-11-12</div><div class="title">CppNote</div></div></a></div><div><a href="/posts/b9315374.html" title="实习笔记一"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/11/10/6730cce7808a4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-10</div><div class="title">实习笔记一</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/07/tEWlYGuVUqFvxw7.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">dropsong</div><div class="author-info__description">把你 TeriTeri 掉哦～(∠・ω< )⌒★</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">105</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">149</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dropsong"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">右下设置简繁切换。安卓和 linux 上代码无法正常缩进。图片均有备份，无法加载可联系博主恢复。部分资源需翻墙。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%B9%B6%E5%8F%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%96%B9%E6%A1%88"><span class="toc-number">1.</span> <span class="toc-text">并发服务器方案</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%9E%8B%EF%BC%88V1%EF%BC%89"><span class="toc-number">2.</span> <span class="toc-text">Reactor模型（V1）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%9E%8B%EF%BC%88V2%EF%BC%89"><span class="toc-number">3.</span> <span class="toc-text">Reactor模型（V2）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%9E%8B%EF%BC%88V3%EF%BC%89"><span class="toc-number">4.</span> <span class="toc-text">Reactor模型（V3）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E3%80%81%E7%BA%BF%E7%A8%8B%E9%80%9A%E4%BF%A1"><span class="toc-number">5.</span> <span class="toc-text">进程、线程通信</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BC%95%E5%85%A5"><span class="toc-number">5.1.</span> <span class="toc-text">引入</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eventfd-%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8"><span class="toc-number">5.2.</span> <span class="toc-text">eventfd 系统调用</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#eventfd-%E7%9A%84%E5%B0%81%E8%A3%85"><span class="toc-number">5.3.</span> <span class="toc-text">eventfd 的封装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%9E%8B%EF%BC%88V4%EF%BC%89"><span class="toc-number">6.</span> <span class="toc-text">Reactor模型（V4）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Reactor%E6%A8%A1%E5%9E%8B%EF%BC%88V5%EF%BC%89"><span class="toc-number">7.</span> <span class="toc-text">Reactor模型（V5）</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9A%E6%97%B6%E5%99%A8-timerfd"><span class="toc-number">8.</span> <span class="toc-text">定时器 timerfd</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%80%E7%9F%AD%E7%BC%96%E8%BE%91%E8%B7%9D%E7%A6%BB"><span class="toc-number">9.</span> <span class="toc-text">最短编辑距离</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%97%E6%B3%95%E5%8E%9F%E7%90%86"><span class="toc-number">9.1.</span> <span class="toc-text">算法原理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8"><span class="toc-number">9.2.</span> <span class="toc-text">应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Stop-words"><span class="toc-number">10.</span> <span class="toc-text">Stop words</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#What-are-Stop-Words"><span class="toc-number">10.1.</span> <span class="toc-text">What are Stop Words</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Types-of-Stop-Words"><span class="toc-number">10.2.</span> <span class="toc-text">Types of Stop Words</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BA%94%E7%94%A8-1"><span class="toc-number">10.3.</span> <span class="toc-text">应用</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#boost-regex"><span class="toc-number">11.</span> <span class="toc-text">boost::regex</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%80%9D%E8%B7%AF%E8%8D%89%E5%9B%BE"><span class="toc-number">12.</span> <span class="toc-text">思路草图</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%A6%BB%E7%BA%BF%E9%83%A8%E5%88%86"><span class="toc-number">13.</span> <span class="toc-text">离线部分</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%9C%A8%E7%BA%BF%E9%83%A8%E5%88%86"><span class="toc-number">14.</span> <span class="toc-text">在线部分</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B3%E9%94%AE%E5%AD%97%E6%8E%A8%E8%8D%90"><span class="toc-number">14.1.</span> <span class="toc-text">关键字推荐</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BD%91%E9%A1%B5%E6%90%9C%E7%B4%A2"><span class="toc-number">14.2.</span> <span class="toc-text">网页搜索</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E6%97%A5%E8%B0%88"><span class="toc-number">15.</span> <span class="toc-text">后日谈</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/ffce18f.html" title="win + debian 双系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/05/10/1MoBUm7KaexdWg5.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="win + debian 双系统"/></a><div class="content"><a class="title" href="/posts/ffce18f.html" title="win + debian 双系统">win + debian 双系统</a><time datetime="2025-05-10T13:16:59.000Z" title="发表于 2025-05-10 21:16:59">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5888fb8e.html" title="微积分补完计划"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2025/01/26/75276539/18ac78490f43bf9da7f8c453a59555b5_2308110768772033072.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="微积分补完计划"/></a><div class="content"><a class="title" href="/posts/5888fb8e.html" title="微积分补完计划">微积分补完计划</a><time datetime="2025-05-01T15:17:43.000Z" title="发表于 2025-05-01 23:17:43">2025-05-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b1b54fd.html" title="机器学习笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/04/01/uzqBjab1yZW9HLU.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="机器学习笔记"/></a><div class="content"><a class="title" href="/posts/b1b54fd.html" title="机器学习笔记">机器学习笔记</a><time datetime="2025-04-01T07:38:47.000Z" title="发表于 2025-04-01 15:38:47">2025-04-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/60ce6585.html" title="拉格朗日插值算法实现"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2024/10/18/285958508/948be2308701fbe302fcdd5d7045d43a_8244217296929491053.jpeg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="拉格朗日插值算法实现"/></a><div class="content"><a class="title" href="/posts/60ce6585.html" title="拉格朗日插值算法实现">拉格朗日插值算法实现</a><time datetime="2025-03-23T15:47:53.000Z" title="发表于 2025-03-23 23:47:53">2025-03-23</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/db829e9d.html" title="商城项目后端"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2024/05/10/225644501/462d472d14c564b3b887d1a958543005_7748922937429727294.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="商城项目后端"/></a><div class="content"><a class="title" href="/posts/db829e9d.html" title="商城项目后端">商城项目后端</a><time datetime="2025-03-19T11:58:56.000Z" title="发表于 2025-03-19 19:58:56">2025-03-19</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By dropsong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [ ['$','$'], ["\\(","\\)"]],
      tags: 'ams'
    },
    chtml: {
      scale: 1.2
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, ''],
        insertScript: [200, () => {
          document.querySelectorAll('mjx-container:not\([display]\)').forEach(node => {
            const target = node.parentNode
            if (target.nodeName.toLowerCase() === 'li') {
              target.parentNode.classList.add('has-jax')
            } else {
              target.classList.add('has-jax')
            }
          });
        }, '', false]
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://cdn.jsdelivr.net/npm/mathjax/es5/tex-mml-chtml.min.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typeset()
}</script><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23lijmGQilj9J9CrdP',
      clientSecret: '255f80b6a1783219f05a3c250856e45342d37c3b',
      repo: 'dropsong.github.io',
      owner: 'dropsong',
      admin: ['dropsong'],
      id: 'd8de7b5bbdd8cdf6bdb042740b351cb7',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><script async src="/js/ali_font.js"></script><!-- hexo injector body_end end --></body></html>