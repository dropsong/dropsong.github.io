<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"><title>商城项目后端 | dropsong's</title><meta name="keywords" content="前端,docker,后端,DRF,JWT,CORS,云服务器,API,vue,nginx,uwsgi"><meta name="author" content="dropsong"><meta name="copyright" content="dropsong"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="一篇随手记，记录开发过程中遇到的问题。 项目介绍项目地址：https:&#x2F;&#x2F;github.com&#x2F;dropsong&#x2F;tiny-shop对应的前端代码：https:&#x2F;&#x2F;github.com&#x2F;dropsong&#x2F;tiny-shop-front 通过 Vue + Django REST framework 实现一个电商平台。 此教学项目的完成方式：前端、资源图片等已经准备好了，我负责后端的开发。 权限和认证">
<meta property="og:type" content="article">
<meta property="og:title" content="商城项目后端">
<meta property="og:url" content="https://dropsong.github.io/posts/db829e9d.html">
<meta property="og:site_name" content="dropsong&#39;s">
<meta property="og:description" content="一篇随手记，记录开发过程中遇到的问题。 项目介绍项目地址：https:&#x2F;&#x2F;github.com&#x2F;dropsong&#x2F;tiny-shop对应的前端代码：https:&#x2F;&#x2F;github.com&#x2F;dropsong&#x2F;tiny-shop-front 通过 Vue + Django REST framework 实现一个电商平台。 此教学项目的完成方式：前端、资源图片等已经准备好了，我负责后端的开发。 权限和认证">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://upload-bbs.miyoushe.com/upload/2024/05/10/225644501/462d472d14c564b3b887d1a958543005_7748922937429727294.jpg">
<meta property="article:published_time" content="2025-03-19T11:58:56.000Z">
<meta property="article:modified_time" content="2025-03-23T16:14:46.000Z">
<meta property="article:author" content="dropsong">
<meta property="article:tag" content="前端">
<meta property="article:tag" content="docker">
<meta property="article:tag" content="后端">
<meta property="article:tag" content="DRF">
<meta property="article:tag" content="JWT">
<meta property="article:tag" content="CORS">
<meta property="article:tag" content="云服务器">
<meta property="article:tag" content="API">
<meta property="article:tag" content="vue">
<meta property="article:tag" content="nginx">
<meta property="article:tag" content="uwsgi">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-bbs.miyoushe.com/upload/2024/05/10/225644501/462d472d14c564b3b887d1a958543005_7748922937429727294.jpg"><link rel="shortcut icon" href="/img/favicon2.jpg"><link rel="canonical" href="https://dropsong.github.io/posts/db829e9d"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.min.css" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"languages":{"hits_empty":"找不到您查询的内容：${query}"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"简"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":230},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '',
  date_suffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: undefined,
  source: {
    justifiedGallery: {
      js: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://cdn.jsdelivr.net/npm/flickr-justified-gallery/dist/fjGallery.min.css'
    }
  },
  isPhotoFigcaption: true,
  islazyload: true,
  isAnchor: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '商城项目后端',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2025-03-24 00:14:46'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><link rel="stylesheet" href="/css/custom.css" media="defer" onload="this.media='all'"><!-- hexo injector head_end start --><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/font-awesome-animation.min.css" media="defer" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/tag_plugins.css" media="defer" onload="this.media='all'"><script src="https://cdn.cbd.int/hexo-butterfly-tag-plugins-plus@latest/lib/assets/carousel-touch.js"></script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.2.0"><link rel="alternate" href="/atom.xml" title="dropsong's" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/07/tEWlYGuVUqFvxw7.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">164</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://upload-bbs.miyoushe.com/upload/2024/05/10/225644501/462d472d14c564b3b887d1a958543005_7748922937429727294.jpg')"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">dropsong's</a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/comments/"><i class="fa-fw fas fa-envelope"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> 友链</span></a></div><div class="menus_item"><a class="site-page" href="/about/"><i class="fa-fw fas fa-heart"></i><span> About</span></a></div></div><div id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">商城项目后端</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="fa-fw post-meta-icon far fa-calendar-alt"></i><span class="post-meta-label">发表于</span><time datetime="2025-03-19T11:58:56.000Z" title="发表于 2025-03-19 19:58:56">2025-03-19</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">7.9k</span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><p>一篇随手记，记录开发过程中遇到的问题。</p>
<h1 id="项目介绍"><a href="#项目介绍" class="headerlink" title="项目介绍"></a>项目介绍</h1><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/dropsong/tiny-shop">https://github.com/dropsong/tiny-shop</a><br>对应的前端代码：<a target="_blank" rel="noopener" href="https://github.com/dropsong/tiny-shop-front">https://github.com/dropsong/tiny-shop-front</a></p>
<p>通过 Vue + Django REST framework 实现一个电商平台。</p>
<p>此教学项目的完成方式：前端、资源图片等已经准备好了，我负责后端的开发。</p>
<p>权限和认证采用 Authentication 用户认证设置，动态设置 Permission、Authentication，Validators 实现字段验证。</p>
<p>序列化和表单验证使用 Serializer、ModelSerializer，动态设置 Serializer.</p>
<p>实现了支付、登录、注册功能。</p>
<ul>
<li>Json Web Token 方式登录，单点登录</li>
<li>手机注册 / 支付宝支付</li>
<li>第三方账户微博登录</li>
</ul>
<p>View 实现 REST API</p>
<ul>
<li>ApiView / GenericView 方式实现 API 接口</li>
<li>ViewSet 和 Router 方式实现 API 接口和 URL 配置</li>
<li><a target="_blank" rel="noopener" href="https://django-filter.readthedocs.io/en/stable/">Django_filter</a>、SearchFilter、OrderFilter 分页</li>
</ul>
<p>商品分类、商品详情、导航栏、热销列表、收藏功能、用户个人中心、个人资料修改、用户留言功能、收获地址功能、购物车、订单管理、首页轮播图。</p>
<p>Django REST framework 部分源码阅读。<br>后台开发文档自动化生成及管理 / 通过 redis 实现缓存。<br>为实现数据分析的需要，统计了商品点击数、收藏数、库存与销量等。<br>Throttling 对用户和 IP 进行限速，实现反爬虫。<br>Sentry 完成线上系统的错误日志的监控和告警。</p>
<h1 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h1><h2 id="前端"><a href="#前端" class="headerlink" title="前端"></a>前端</h2><p>为什么前端可以独立开发？</p>
<ul>
<li>前端会自己启动一个简单的 web 服务器，监听端口例如 8080，来渲染前端代码。</li>
<li>若前端需要数据，可以通过 axios 发送异步请求给后端。</li>
<li>Mockjs 可以根据 json 格式生成一些随机数据。</li>
</ul>
<p>单页面和多页面对比（前端相关）：<br><a target="_blank" rel="noopener" href="https://juejin.cn/post/6844903512107663368">https://juejin.cn/post/6844903512107663368</a></p>
<p>前后端分离的开发方式可以大致分为两种：</p>
<ol>
<li>前端没开发好。这时后端开发就会省事一点，可以在 drf 提供的测试页面测试。</li>
<li>前端开发好了。这时候后端就要配合前端，将前端跑起来，每开发一个接口，就简单测试一个接口。</li>
</ol>
<p><strong>如何运行一个 vue 项目？</strong></p>
<p>在 vscode 中安装推荐插件，安装 node 和 npm.</p>
<p>安装 nvm 以管理版本，注意在命令行安装 nvm 时梯子换成虚拟网卡模式，或者<a target="_blank" rel="noopener" href="https://blog.csdn.net/hzjanger/article/details/102876969">在 hosts 文件中追加内容</a>。</p>
<p>注意要使用匹配的 node 版本。</p>
<p>问题： <code>node-sass</code> 可能无法找到适合当前环境（Linux 64-bit with Node.js 12.x）的绑定文件。<br>解决方法： <code>npm rebuild node-sass</code></p>
<h2 id="后端"><a href="#后端" class="headerlink" title="后端"></a>后端</h2><p>系统：debian12<br>数据库：mysql  Ver 8.4.4 for Linux on x86_64 (MySQL Community Server - GPL)</p>
<p>注意，在 debian 上需要先卸载 MariaDB，否则会产生冲突。</p>
<p>使用的第三方： </p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/zhangfisher/DjangoUeditor">DjangoUeditor</a><br>这个 DjangoUeditor 版本众多，多数已经过时了，与 Django 4.2 不兼容。我改动了一点代码，使这个项目可以运行，但也许还有其他潜在的错误。</li>
<li><a target="_blank" rel="noopener" href="https://github.com/python-social-auth/social-core">social-core</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jazzband/djangorestframework-simplejwt">djangorestframework-simplejwt</a><br>rest_framework_jwt 已经不再维护，故迁移到此。</li>
</ul>
<h1 id="导入数据"><a href="#导入数据" class="headerlink" title="导入数据"></a>导入数据</h1><p>迁移之后根据模型类生成数据库的表。</p>
<p>在 <code>./db_tools/data</code> 下有一些数据，我们用 <code>./db_tools</code> 下的 <code>import_category_data.py</code> 和 <code>import_goods_data.py</code> 两个脚本导入。</p>
<p>若导入数据出错，需要清空一些含有外键或者自关联的表，可以执行：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">set</span> foreign_key_checks <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"><span class="keyword">truncate</span> <span class="keyword">table</span> 表名;   <span class="operator">/</span><span class="operator">/</span> 如果表中没有数据</span><br><span class="line"><span class="keyword">set</span> foreign_key_checks <span class="operator">=</span> <span class="number">1</span>;</span><br></pre></td></tr></table></figure>
<h1 id="CORS-跨源资源共享"><a href="#CORS-跨源资源共享" class="headerlink" title="CORS 跨源资源共享"></a>CORS 跨源资源共享</h1><p>一个清晰的介绍视频：</p>
<div style="position: relative; width: 100%; height: 0; padding-bottom: 75%;">
    <iframe src="https://player.bilibili.com/player.html?bvid=BV1T5411v7to&page=1&autoplay=0" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" style="position:absolute; height: 100%; width: 100%;"> </iframe>
</div>

<p><br></p>
<p>在项目中安装也很方便：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install django-cors-headers</span><br></pre></td></tr></table></figure>
<p>此外，在后端代码中还需要一些额外的配置，具体参阅 <code>settings.py</code> 中相关注释。</p>
<p><strong>如何在 debian 的 chrome 上禁用安全模式，允许跨域，方便开发？</strong></p>
<p>首先，找到 chrome:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">which google-chrome</span><br></pre></td></tr></table></figure>
<p>在对应目录下，执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">google-chrome --disable-web-security --user-data-dir=&quot;/tmp/chrome_dev_profile&quot;</span><br></pre></td></tr></table></figure>
<h1 id="用户登录和手机注册"><a href="#用户登录和手机注册" class="headerlink" title="用户登录和手机注册"></a>用户登录和手机注册</h1><h2 id="Token-认证登录"><a href="#Token-认证登录" class="headerlink" title="Token 认证登录"></a>Token 认证登录</h2><p>本小节对 token 的使用作简单演示。</p>
<p>在 <code>settings.py</code> 中：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">INSTALLED_APPS = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">&#x27;rest_framework.authtoken&#x27;</span>,  <span class="comment"># token 登录需要使用这个</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>然后在 <code>./urls.py</code> 中：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework.authtoken <span class="keyword">import</span> views <span class="comment"># 用于理解 token</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    re_path(<span class="string">r&#x27;^api-token-auth/&#x27;</span>, views.obtain_auth_token), <span class="comment"># 用于理解 token</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在 postman 中：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/A7GpOVNdFleTP41.jpg" alt="101-1.jpg"></p>
<p>得到结果：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/BdxphQJZD4uXVrP.png" alt="101-2.png"></p>
<p>这个 token 也可以在后端的数据库中找到。</p>
<p>也可以使用如下命令生成 token :</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py drf_create_token -r admin</span><br></pre></td></tr></table></figure>
<p>注意这样会覆盖原先的 token 值。</p>
<p>现在做实验进一步理解 token. 启用 vscode 的调试，将断点打在下图位置（即 <code>class GoodsListViewSet(viewsets.ReadOnlyModelViewSet)</code> 点进去）。注意要在配置文件中设置 <code>&quot;justMyCode&quot;: false</code> .</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;name&quot;: &quot;Python Debugger: Django&quot;,</span><br><span class="line">    &quot;type&quot;: &quot;debugpy&quot;,</span><br><span class="line">    &quot;request&quot;: &quot;launch&quot;,</span><br><span class="line">    &quot;args&quot;: [</span><br><span class="line">        &quot;runserver&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;django&quot;: true,</span><br><span class="line">    &quot;autoStartBrowser&quot;: false,</span><br><span class="line">    &quot;program&quot;: &quot;$&#123;workspaceFolder&#125;/manage.py&quot;,</span><br><span class="line">    &quot;justMyCode&quot;: false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/QjDa5U8ysR9nmce.png" alt="101-3.png" title="已登录 admin 用户"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/ha8WfbYwKNZvrpL.png" alt="101-4.png" title="无登录用户"></p>
<p>此时用 postman 发送如下请求也会卡住：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/zJHaPduYwLqp2Vm.png" alt="101-5.png"></p>
<p>在 postman 中的 Headers 中加上 token 就可以看到：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/GAFxObvfsCMz9Do.png" alt="101-6.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/G6tDjdgnR3u9B8w.png" alt="101-7.png"></p>
<p>说明此时根据 token 辨认出了用户。</p>
<h2 id="JWT-Token"><a href="#JWT-Token" class="headerlink" title="JWT Token"></a>JWT Token</h2><p>注意，<strong>在和前端联调时，不能登录 django 自带的管理后台。</strong></p>
<h3 id="基础知识和配置"><a href="#基础知识和配置" class="headerlink" title="基础知识和配置"></a>基础知识和配置</h3><p>简要介绍：</p>
<ul>
<li>所有的服务器都有一把解密的钥匙，用户登录时，将用户的信息通过加密算法加密得到密文，这个密文就是 JWT Token.</li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/wenqiangit/p/9592132.html">https://www.cnblogs.com/wenqiangit/p/9592132.html</a> （已在 <a target="_blank" rel="noopener" href="https://archive.org/">https://archive.org/</a> 备份）</li>
<li><a target="_blank" rel="noopener" href="https://www.bilibili.com/video/BV1ob4y1Y7Ep">（推荐）Cookie、Session、Token究竟区别在哪？如何进行身份认证，保持用户登录状态？</a></li>
</ul>
<p>在 <code>./urls.py</code> 中：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainPairView, TokenRefreshView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    path(<span class="string">&#x27;jwt-auth/&#x27;</span>, TokenObtainPairView.as_view()), <span class="comment"># 理解 jwt</span></span><br><span class="line">    path(<span class="string">&#x27;jwt-refresh/&#x27;</span>, TokenRefreshView.as_view()),</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>然后在 settings 中配置：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> datetime</span><br><span class="line">JWT_AUTH = &#123;</span><br><span class="line">    <span class="string">&#x27;JWT_EXPIRATION_DELTA&#x27;</span>: datetime.timedelta(days=<span class="number">7</span>),</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">REST_FRAMEWORK =&#123;</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    <span class="string">&#x27;DEFAULT_AUTHENTICATION_CLASSES&#x27;</span>: [</span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.BasicAuthentication&#x27;,</span></span><br><span class="line">        <span class="comment"># &#x27;rest_framework.authentication.SessionAuthentication&#x27;,</span></span><br><span class="line">        <span class="string">&#x27;rest_framework_simplejwt.authentication.JWTAuthentication&#x27;</span>,</span><br><span class="line">    ],</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>通过 postman 发送请求：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/QnjO9HSTrwgqX5e.png" alt="101-8.png"></p>
<p>实际上，将图片中的响应全丢给 AI 分析完全没问题（这个项目本就是我写着练习的，token 放出来无所谓）。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    &quot;refresh&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoicmVmcmVzaCIsImV4cCI6MTc0MDkxNTMwOCwiaWF0IjoxNzQwODI4OTA4LCJqdGkiOiI5MTkzZjRhMzhlMzA0NDMwYjA1NWE3ZDVmNzNmYzIzNyIsInVzZXJfaWQiOjF9.ltBS3iEvabqZ_Y1cyZMANjqgekQUXmZ19_9-_imWPOU&quot;,</span><br><span class="line">    &quot;access&quot;: &quot;eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ0b2tlbl90eXBlIjoiYWNjZXNzIiwiZXhwIjoxNzQwODI5MjA4LCJpYXQiOjE3NDA4Mjg5MDgsImp0aSI6IjBmZDE0ZjA1NDBkYTQzYmZiNzhjYzY1OGRlOWRlNDJiIiwidXNlcl9pZCI6MX0.8K3nTODh1NEAwi_gvXj4HoTc6aPshyyTZi1tP-PG2YQ&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>refresh Token:</p>
<ul>
<li>类型：刷新 token</li>
<li>用途：用于刷新访问 token。</li>
</ul>
<p>access Token:</p>
<ul>
<li>类型：访问 token</li>
<li>用途：用于访问受保护的 API 或资源。</li>
</ul>
<p>这两个 token 通常一起使用：access token 用于短期认证，过期后可以用 refresh token 获取新的 access token。</p>
<p>签名的目的：</p>
<blockquote>
<p>最后一步签名的过程，实际上是对头部以及负载内容进行签名，防止内容被窜改。如果有人对头部以及负载的内容解码之后进行修改，再进行编码，最后加上之前的签名组合形成新的JWT的话，那么服务器端会判断出新的头部和负载形成的签名和JWT附带上的签名是不一样的。如果要对新的头部和负载进行签名，在不知道服务器加密时用的密钥的话，得出来的签名也是不一样的。</p>
</blockquote>
<p>信息暴露：</p>
<blockquote>
<p>在这里大家一定会问一个问题：Base64 是一种编码，是可逆的，那么我的信息不就被暴露了吗？<br>是的。所以，在 JWT 中，不应该在负载里面加入任何敏感的数据。在上面的例子中，我们传输的是用户的 User ID。这个值实际上不是什么敏感内容，一般情况下被知道也是安全的。但是像密码这样的内容就不能被放在 JWT 中了。如果将用户的密码放在了 JWT 中，那么怀有恶意的第三方通过 Base64 解码就能很快地知道你的密码了。<br>因此 JWT 适合用于向Web应用传递一些非敏感信息。 JWT 还经常用于设计用户认证和授权系统，甚至实现 Web 应用的单点登录。</p>
</blockquote>
<h3 id="实验-access-和-refresh"><a href="#实验-access-和-refresh" class="headerlink" title="实验 - access 和 refresh"></a>实验 - access 和 refresh</h3><p>如果 access token 过期，可以用 refresh token 刷新（若 refresh token 未过期）。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/tCwPmKqS4MvhW75.png" alt="101-9.png"></p>
<p>如果 refresh token 也过期或无效，会返回错误（这个时候就需要用户重新登录了？）。</p>
<p>将返回的新的 access token 复制下来，用于后续请求。</p>
<p>接下来使用 access token 访问受保护资源。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/01/q1DrTyUe9JIGYLA.png" alt="101-10.png"></p>
<p>在打断点的调试实验中，我们看到服务器识别出了用户。点击继续，postman 得到了正确的响应数据。</p>
<h3 id="实验-Sliding-Token"><a href="#实验-Sliding-Token" class="headerlink" title="实验 - Sliding Token"></a>实验 - Sliding Token</h3><p>然而使用 access 和 refresh 对这个项目还是麻烦了点，我们使用滑动令牌（Sliding Token）。</p>
<p><a target="_blank" rel="noopener" href="https://django-rest-framework-simplejwt.readthedocs.io/en/latest/token_types.html">官方文档</a>：</p>
<blockquote>
<p>Sliding tokens offer a more convenient experience to users of tokens with the trade-offs of being less secure and, in the case that the blacklist app is being used, less performant. A sliding token is one which contains both an expiration claim and a refresh expiration claim. As long as the timestamp in a sliding token’s expiration claim has not passed, it can be used to prove authentication. Additionally, as long as the timestamp in its refresh expiration claim has not passed, it may also be submitted to a refresh view to get another copy of itself with a renewed expiration claim.</p>
</blockquote>
<p>在 <code>./urls.py</code> 中：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.views <span class="keyword">import</span> TokenObtainSlidingView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    path(<span class="string">&#x27;login/&#x27;</span>, TokenObtainSlidingView.as_view()),</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在 postman 中测试：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/02/n6bVxhN5wZpLmlH.png" alt="101-11.png"></p>
<p>在前端测试效果，发现登录之后，可以识别登录用户的身份：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/02/TL6heKva8W9xglS.png" alt="101-12.png"></p>
<p>注意，这个令牌是会刷新的。具体机制上网搜。</p>
<h2 id="手机号登录"><a href="#手机号登录" class="headerlink" title="手机号登录"></a>手机号登录</h2><p>现在想要实现这样的功能：用户不仅可以以用户名登录，也可以以手机号登录。</p>
<p>向数据库中的 admin 用户赋一个电话号码。</p>
<p>在 settings 中增加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (</span><br><span class="line">    <span class="string">&#x27;users.views.CustomBackend&#x27;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>然后在 <code>./apps/users/views.py</code> 中：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.contrib.auth.backends <span class="keyword">import</span> ModelBackend</span><br><span class="line"><span class="keyword">from</span> django.contrib.auth <span class="keyword">import</span> get_user_model</span><br><span class="line"><span class="keyword">from</span> django.db.models <span class="keyword">import</span> Q</span><br><span class="line"></span><br><span class="line">User = get_user_model()   <span class="comment"># 获取用户模型</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomBackend</span>(<span class="title class_ inherited__">ModelBackend</span>):  <span class="comment"># 继承 ModelBackend 类</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    自定义用户验证</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 重写 authenticate 方法，仿照原来的函数写就行，注意返回类型</span></span><br><span class="line">    <span class="keyword">def</span> <span class="title function_">authenticate</span>(<span class="params">self, request,username=<span class="literal">None</span>, password=<span class="literal">None</span>, **kwargs</span>):</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            user = User.objects.get(Q(username=username)|Q(mobile=username))</span><br><span class="line">            <span class="keyword">if</span> user.check_password(password):</span><br><span class="line">                <span class="keyword">return</span> user</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">None</span></span><br></pre></td></tr></table></figure>
<p>即可实现手机号登录。</p>
<h2 id="手机号注册"><a href="#手机号注册" class="headerlink" title="手机号注册"></a>手机号注册</h2><p>首先我们需要一个帮助发验证码的网站，让短信提供商发验证码。</p>
<p>一个例子是<a target="_blank" rel="noopener" href="https://www.yunpian.com/">云片网</a>，这类网站审核比较严格，需要实名认证，发送的短信也必须是审核后的模板（里面留一个验证码的位置）。发送短信的样例代码在 <code>./apps/utils/yunpian.py</code> .</p>
<p>相关逻辑在 <code>./apps/users/serializers.py</code>, <code>./apps/users/views.py</code>, <code>./ShopProj/urls.py</code> 中。</p>
<p>登录后端 <code>http://127.0.0.1:8000/users/</code>，提示 GET 方法不允许。我们在下面 post 一个错误的数据，会提示验证码错误。</p>
<p>在 users_verifycode 表中手工填入用户和验证码数据（也就是这里直接在数据库里填了个假的），再次 post，成功。且在后端数据库 users_userprofile 中，看到刚刚新增的用户。</p>
<p>在开发过程中，遇到一个实际的问题：注册之后，浏览器 F12 看不到 token 和 name. 实际上注册之后并没有登录，若想要登录，需要仿照登录的返回数据格式。为此我作了一些修改，见 <code>./apps/users/views.py</code> 中 <code>class UserViewset</code> 的注释。</p>
<p>刚才的实验是在数据库中填了一个测试用的假验证码，接下来完成一个实际的验证码发送。相关代码在 <code>./apps/users/serializers.py</code> 中的类 <code>SmsSerializer</code>、<code>./apps/users/views.py</code> 中的类 <code>SmsCodeViewset</code>.</p>
<p>测试成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/04/3aZqA7ItTergxQE.png" alt="101-13.png"></p>
<h1 id="问题排查-文档生成"><a href="#问题排查-文档生成" class="headerlink" title="问题排查-文档生成"></a>问题排查-文档生成</h1><p>记录一次问题排查过程。</p>
<p>本想使用 drf 的 api 文档自动生成，但是遇到了一些问题。推测是版本不兼容的问题，将报错丢给 AI：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/05/ZcFR862etVbpSiu.png" alt="101-14.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/05/5tRKmi2YuQjI8ck.png" alt="101-15.png"></p>
<p>按照 AI 给的建议：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/05/qNonJPShDCWvTAZ.jpg" alt="101-16.jpg"></p>
<p>操作，得到效果如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/05/sxDWO9iyfYU7IRF.png" alt="101-17.png"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/05/RhlGBkzsfivqXux.png" alt="101-18.png"></p>
<p>虽然实际上没觉得这东西很好用就是了，之前实习的时候都是用的 ApiFox.</p>
<h1 id="问题排查-认证"><a href="#问题排查-认证" class="headerlink" title="问题排查-认证"></a>问题排查-认证</h1><p>遇到一个经典问题，相关的讨论还挺多的：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/59771853/anonymoususer-when-logged-with-simplejwt">https://stackoverflow.com/questions/59771853/anonymoususer-when-logged-with-simplejwt</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/jazzband/djangorestframework-simplejwt/issues/562">https://github.com/jazzband/djangorestframework-simplejwt/issues/562</a></li>
<li><a target="_blank" rel="noopener" href="https://groups.google.com/g/django-rest-framework/c/YvWiNNCmk8o">https://groups.google.com/g/django-rest-framework/c/YvWiNNCmk8o</a></li>
</ul>
<p>一个可能比较靠谱的描述（上面第二个链接，我并不能验证其真实性）：</p>
<blockquote>
<p>…but JWTauthentication does not populate the request.user object attribute hence I get AnonymousUser, but when i access the django admin it works because request.user is populated by the ‘django.contrib.auth.middleware.AuthenticationMiddleware’</p>
</blockquote>
<p>这个问题还是挺棘手的，可能是 djangorestframework_simplejwt 本身的问题。我的解决方案比较原始，仅举一例：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> <span class="title function_">get_queryset</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="comment"># 只能查看自己的收藏</span></span><br><span class="line">    cookie_header = self.request.headers.get(<span class="string">&#x27;Cookie&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">    <span class="keyword">match</span> = re.search(<span class="string">r&#x27;name=([^;]+)&#x27;</span>, cookie_header)</span><br><span class="line">    uname = <span class="string">&#x27;&#x27;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">        uname = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">    uuser = UserProfile.objects.get(username=uname)</span><br><span class="line">    <span class="keyword">return</span> UserFav.objects.<span class="built_in">filter</span>(user=uuser)</span><br></pre></td></tr></table></figure>
<p>相关的代码在 <code>./apps/utils/diyfunc.py</code> 中。</p>
<h1 id="Azure-云服务器"><a href="#Azure-云服务器" class="headerlink" title="Azure 云服务器"></a>Azure 云服务器</h1><h2 id="服务器相关"><a href="#服务器相关" class="headerlink" title="服务器相关"></a>服务器相关</h2><p>为使用支付宝支付（沙箱模拟），需要公网 IP.</p>
<p>在阿里云购买一台 ECS 云服务器，选择合适的操作系统（这里我选了 debian），配置安全组、密钥对，使用 vscode SSH 连接时，注意 <code>.pem</code> 文件的权限要求严格，不能随便给很多权限。</p>
<p>在云服务器上安装好 Python 的虚拟环境。</p>
<p>反转了，因为阿里云的学生认证方案太弱鸡，一 runserver 就炸了，改用 Azure 的学生认证，Standard D2s v3 (2 vcpu，8 GiB 内存)，这个够用了。os 是 Linux (ubuntu 22.04)，ubuntu 确实方便，就不要在云服务器上搞什么 debian 了。git clone 也不会出现阿里云那样莫须有的 timeout.</p>
<p>注意要在网络设置中放行需要的端口。</p>
<p>注意访问 <code>公网IP:8000</code> 时关掉梯子，或者配置以下规则（仅示例，并非一定是这个格式）：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Rule Type：IP-CIDR</span><br><span class="line">Rule Content：公网IP/32</span><br><span class="line">Proxy Policy：DIRECT</span><br><span class="line">Action：PREPEND RULE</span><br></pre></td></tr></table></figure>
<p>和前端联调时需要在代码中将 IP 地址改为这个云服务器的 IP.</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/11/hXaWJxHjVFzC3eT.png" alt="101-19.png"></p>
<p>可以看到，请求的地址变成了服务器的 IP.</p>
<h2 id="使用-docker"><a href="#使用-docker" class="headerlink" title="使用 docker"></a>使用 docker</h2><blockquote>
<p>这是一次失败的尝试，但暂且记录。</p>
</blockquote>
<p>docker 安装相关文档：<br><a target="_blank" rel="noopener" href="https://docs.docker.com/engine/install/debian/">https://docs.docker.com/engine/install/debian/</a></p>
<p>docker 相关资料见 <a href="https://dropsong.github.io/posts/b9315374.html">实习笔记一</a> 。</p>
<p>在编写完 Dockerfile 后，构建 Docker 镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker build -t my-drf-app .</span><br></pre></td></tr></table></figure>
<p>使用 docker save 将镜像保存到文件：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker save -o my-drf-app.tar my-drf-app</span><br></pre></td></tr></table></figure>
<p>把这个 <code>.tar</code> 文件上传到云服务器：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">scp /path/filename username@serverIp:/path</span><br></pre></td></tr></table></figure>
<p>然后在云服务器上加载这个镜像：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker load -i my-drf-app.tar</span><br></pre></td></tr></table></figure>
<p>最后也尝试了 Docker Compose，但没有成功。</p>
<h1 id="支付宝支付"><a href="#支付宝支付" class="headerlink" title="支付宝支付"></a>支付宝支付</h1><p>进入支付宝开放平台，控制台，沙箱。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/11/TbNrBKIhvMs673e.jpg" alt="101-20.jpg"></p>
<p>生成密钥：<br><a target="_blank" rel="noopener" href="https://opendocs.alipay.com/common/02kipl">https://opendocs.alipay.com/common/02kipl</a></p>
<p>更多细节参考 <code>./apps/trade/keys/readme.md</code> .</p>
<p>支付宝 API 文档：<br><a target="_blank" rel="noopener" href="https://opendocs.alipay.com/apis/api_1/alipay.trade.page.pay/">https://opendocs.alipay.com/apis/api_1/alipay.trade.page.pay/</a></p>
<p>电脑网站支付的支付接口 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/028r8t?scene=22">alipay.trade.page.pay</a>（统一收单下单并支付页面接口）调用时序图如下：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/12/hVSL843ilAx2HJK.png" alt="101-21.png"></p>
<p>调用流程如下：</p>
<ol>
<li>商家系统调用 alipay.trade.page.pay（统一收单下单并支付页面接口）向支付宝发起支付请求，支付宝对商家请求参数进行校验，而后重新定向至用户登录页面。</li>
<li>用户确认支付后，支付宝通过 get 请求 returnUrl（商户入参传入），返回同步返回参数。</li>
<li>交易成功后，支付宝通过 post 请求 notifyUrl（商户入参传入），返回异步通知参数。</li>
<li>若由于网络等原因，导致商家系统没有收到异步通知，商家可自行调用 alipay.trade.query（统一收单交易查询接口）查询交易以及支付信息（商家也可以直接调用该查询接口，不需要依赖异步通知）。</li>
</ol>
<p>注意： </p>
<ul>
<li>由于同步返回的不可靠性，支付结果必须以异步通知或查询接口返回为准，不能依赖同步跳转。</li>
<li>商家系统接收到异步通知以后，<strong>必须通过验签（验证通知中的 sign 参数）来确保支付通知是由支付宝发送的</strong>。详细验签规则可查看 <a target="_blank" rel="noopener" href="https://opendocs.alipay.com/open/270/105902#s7">异步通知验签</a>。</li>
<li>接收到异步通知并验签通过后，请务必核对通知中的 app_id、out_trade_no、total_amount 等参数值是否与请求中的一致，并根据 trade_status 进行后续业务处理。</li>
<li>在支付宝端，partnerId 与 out_trade_no 唯一对应一笔单据，商家端保证不同次支付 out_trade_no 不可重复；若重复，支付宝会关联到原单据，基本信息一致的情况下会以原单据为准进行支付。</li>
</ul>
<p><del>复用了别人的代码，看起来还挺复杂的，在 <code>./apps/utils/</code> 下可以看到。</del></p>
<p>下面这段代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">return_url = <span class="string">&#x27;http://&#x27;</span>+IP+<span class="string">&#x27;/alipay/return/?charset=utf-8&amp;out_trade_n=20241115999&amp;method=alipay.trade.page.pay.return&amp;total_amount=100.00&amp;sign=K1QkuZEX5nQDHzL%2BuCh3chDLesPXWyqmA2Trc5IYbH06jqUfAUle8mezNAFcGld6Lcv4KKXlwAs7a84y3yoYdjl7nxWaxk4sif%2F1DsWT6FvLJQsCjc8hsiE%2BDHLoeaiiHtJ9LsmYDtKyT4vUcg3yA3b3Q%2B4ybejLBQRjlu9r4WtlxO3oaloE880Ujwq4TthnVWzzeWMdIKdacCnnYVI9Fc2H1RdxfTQtRHXEWWW2dCBe5e4BzYOD7i4DQBYPtA4lFM%2FcTY700t0%2B7etjSzC5fS8l%2B6IO3Ea393UWVAvmJkzfYj9wRapai4qMh9KdR%2BEiGsBkXnl7lfXz9o767QQPOA%3D%3D&amp;trade_no=20250515163741149&amp;auth_app_id=2016101400687743&amp;version=1.0&amp;app_id=2016101400687743&amp;sign_type=RSA2&amp;seller_id=2088102179599265&amp;timestamp=2019-11-15+17%3A08%3A40&#x27;</span></span><br><span class="line"></span><br><span class="line">o:ParseResult = urlparse(return_url)</span><br><span class="line">query = parse_qs(o.query)</span><br><span class="line">processed_query = &#123;&#125;</span><br><span class="line">ali_sign = query.pop(<span class="string">&quot;sign&quot;</span>)[<span class="number">0</span>]</span><br></pre></td></tr></table></figure>
<p><code>urlparse</code> 函数用于解析 URL，并将其分解为各个组成部分。它的返回值是一个 <code>ParseResult</code> 对象，该对象包含以下属性：</p>
<ul>
<li><code>scheme</code>: URL 的协议部分（例如 http 或 https）</li>
<li><code>netloc</code>: 网络位置部分（例如 www.example.com）</li>
<li><code>path</code>: URL 的路径部分（例如 /path/to/resource）</li>
<li><code>params</code>: URL 的参数部分（通常很少使用）</li>
<li><code>query</code>: URL 的查询字符串部分（例如 key1=value1&amp;key2=value2）</li>
<li><code>fragment</code>: URL 的片段标识符部分（例如 #section1）</li>
</ul>
<p><code>parse_qs</code> 函数用于解析查询字符串，并将其转换为一个字典。字典的键是查询参数的名称，值是一个包含参数值的列表。</p>
<p><del>一种可能更方便的做法：</del><br><a target="_blank" rel="noopener" href="https://pypi.org/project/alipay-sdk-python/">https://pypi.org/project/alipay-sdk-python/</a></p>
<p>上面链接中的代码有 <a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/2941995/python-ignore-incorrect-padding-error-when-base64-decoding">bug</a>, 我已经修了，但是包括之前别人的代码生成的链接，都会遇到 <strong>502 Bad Gateway</strong> 问题，相关讨论见：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://open.alipay.com/portal/forum/post/181001027">https://open.alipay.com/portal/forum/post/181001027</a></li>
<li><a target="_blank" rel="noopener" href="https://open.alipay.com/portal/forum/post/160801014">https://open.alipay.com/portal/forum/post/160801014</a></li>
<li><a target="_blank" rel="noopener" href="https://opendocs.alipay.com/support/01razf">https://opendocs.alipay.com/support/01razf</a></li>
</ul>
<p>在本文的撰写阶段，支付宝的沙箱可能有点问题，在这个功能上浪费太多时间了，我决定跳过它。</p>
<h1 id="前端部署"><a href="#前端部署" class="headerlink" title="前端部署"></a>前端部署</h1><p>在前端项目中，删除 dist 文件夹下的内容。</p>
<p><code>npm run build</code> 遇到了一些问题，下面是解决方案：</p>
<p>The error is due to the <code>--colors</code> option being removed in newer versions of webpack-cli. You need to remove <code>--colors</code> from your build script. To fix this, update your <code>package.json</code> file and remove the <code>--colors</code> option from the build script. Your updated build script should look like this: <code>webpack --progress --profile --config webpack.prod.js</code>.</p>
<p>此时，仍有新的问题。方案如下：</p>
<p>The error you’re encountering is likely due to an incompatibility between the version of webpack and the configuration or dependencies you’re using. Since you’re using an older version of webpack (^2.5.1), it might be beneficial to update webpack and related dependencies to a more recent version.</p>
<p>Update webpack and webpack-cli to the latest version:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev webpack webpack-cli</span><br></pre></td></tr></table></figure>
<p>Ensure all other webpack-related dependencies are compatible with the new version of webpack. You might need to update them as well:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install --save-dev webpack-dev-server webpack-dev-middleware webpack-hot-middleware</span><br></pre></td></tr></table></figure>
<p>After making these changes, try running the build script again:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm run build</span><br></pre></td></tr></table></figure>
<p>在后端 settings 中设置：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [BASE_DIR / <span class="string">&quot;templates&quot;</span>],  <span class="comment"># add</span></span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line">STATICFILES_DIRS = (</span><br><span class="line">    os.path.join(BASE_DIR, <span class="string">&quot;static&quot;</span>),</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>对生成的 <code>index.html</code> 做一些修改：</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE <span class="keyword">html</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">&quot;utf-8&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>首页<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">&quot;app&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">&quot;text/javascript&quot;</span> <span class="attr">src</span>=<span class="string">&quot;/static/index.entry.js&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>在全局 urls 中配置：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.views.generic <span class="keyword">import</span> TemplateView</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    re_path(<span class="string">r&#x27;^index/&#x27;</span>, TemplateView.as_view(template_name=<span class="string">&quot;index.html&quot;</span>), name=<span class="string">&quot;index&quot;</span>),</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>注意前端 build 的时候，填写正确的 IP 地址：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">// let local_host = &#x27;http://127.0.0.1:8000&#x27;;</span><br><span class="line">let local_host = &#x27;http://云服务器IP:8000&#x27;;</span><br></pre></td></tr></table></figure>
<h1 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h1><p>相关资料：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://github.com/chibisov/drf-extensions">https://github.com/chibisov/drf-extensions</a></li>
<li><a target="_blank" rel="noopener" href="https://chibisov.github.io/drf-extensions/docs/">https://chibisov.github.io/drf-extensions/docs/</a></li>
<li><a target="_blank" rel="noopener" href="https://web.archive.org/web/20230327155332/https://www.zmrenwu.com/courses/django-rest-framework-tutorial/materials/102/">https://web.archive.org/web/20230327155332/https://www.zmrenwu.com/courses/django-rest-framework-tutorial/materials/102/</a></li>
</ul>
<p>使用 redis.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip install drf-extensions</span><br><span class="line">pip install django-redis</span><br></pre></td></tr></table></figure>
<p>修改部分代码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> rest_framework_extensions.cache.mixins <span class="keyword">import</span> CacheResponseMixin</span><br><span class="line"><span class="keyword">class</span> <span class="title class_">GoodsListViewSet</span>(CacheResponseMixin, viewsets.ReadOnlyModelViewSet):</span><br><span class="line">    <span class="comment"># ...</span></span><br></pre></td></tr></table></figure>
<p>安装 redis-server：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install redis-server</span><br></pre></td></tr></table></figure>
<p>在 settings 中配置：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">REST_FRAMEWORK_EXTENSIONS = &#123;</span><br><span class="line">    <span class="string">&#x27;DEFAULT_CACHE_RESPONSE_TIMEOUT&#x27;</span>: <span class="number">60</span> * <span class="number">15</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">CACHES = &#123;</span><br><span class="line">    <span class="string">&quot;default&quot;</span>: &#123;</span><br><span class="line">        <span class="string">&quot;BACKEND&quot;</span>: <span class="string">&quot;django_redis.cache.RedisCache&quot;</span>,</span><br><span class="line">        <span class="string">&quot;LOCATION&quot;</span>: <span class="string">&quot;redis://127.0.0.1:6379&quot;</span>,</span><br><span class="line">        <span class="string">&quot;OPTIONS&quot;</span>: &#123;</span><br><span class="line">            <span class="string">&quot;CLIENT_CLASS&quot;</span>: <span class="string">&quot;django_redis.client.DefaultClient&quot;</span>,</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>本地 runserver, 访问两个链接：</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/goods/">http://127.0.0.1:8000/goods/</a></li>
<li><a target="_blank" rel="noopener" href="http://127.0.0.1:8000/goods/?min_price=&amp;max_price=&amp;name=&amp;is_hot=true&amp;is_new=">http://127.0.0.1:8000/goods/?min_price=&amp;max_price=&amp;name=&amp;is_hot=true&amp;is_new=</a></li>
</ul>
<p>可以在 redis-cli 里看到：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;:1:1e10e0a6cf89037108644311f918bb66&quot;</span><br><span class="line">2) &quot;:1:dad87b4a4e03232d700b5c34e010ebc2&quot;</span><br></pre></td></tr></table></figure>
<h1 id="第三方登录"><a href="#第三方登录" class="headerlink" title="第三方登录"></a>第三方登录</h1><p>大致原理：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/17/olRjcVfxMZgP69O.png" alt="101-22.png"></p>
<p>微博开放平台的相关文档：<br><a target="_blank" rel="noopener" href="https://open.weibo.com/wiki/%E7%BD%91%E7%AB%99%E6%8E%A5%E5%85%A5%E4%BB%8B%E7%BB%8D">https://open.weibo.com/wiki/%E7%BD%91%E7%AB%99%E6%8E%A5%E5%85%A5%E4%BB%8B%E7%BB%8D</a></p>
<p>开放平台的审核大约两天左右。</p>
<p>填写授权回调页：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/20/bqCYNpaQgnoz1HE.png" alt="101-23.png"></p>
<p>应用还未通过审核时，不能大范围推广。可以设置测试帐号来测试尚在开发中的应用。添加自己的微博账号即可。</p>
<p>Oauth2.0 相关文档：<br><a target="_blank" rel="noopener" href="https://open.weibo.com/wiki/Oauth2/authorize">https://open.weibo.com/wiki/Oauth2/authorize</a></p>
<h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><p>在 <code>./apps/utils/weibo_login.py</code> 中，我写了一些代码以实验微博登录的流程。</p>
<p>调用 <code>get_auth_url()</code> 函数以获取链接。可能会遇到 21322 重定向地址不匹配问题，原因是授权回调页面的 url 最后少了一个 <code>/</code>，加上即可。</p>
<p>点击这个链接，注意需要事先退出所有微博帐号（其实开个隐私标签页就行了），会进入微博的登录界面。</p>
<p>登录（扫码）后，我们可以得到一个链接：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://云服务器IP:8000/complete/weibo/?code=c和谐b</span><br></pre></td></tr></table></figure>
<p>将这个 code 的值填入 <code>./apps/utils/weibo_login.py</code> 的 <code>get_access_token()</code> 函数的形参中。</p>
<p>运行 <code>get_access_token()</code> 函数，得到 access_token, 即可通过 access_token 去使用微博的 API 接口：</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://open.weibo.com/wiki/%E5%BE%AE%E5%8D%9AAPI">https://open.weibo.com/wiki/%E5%BE%AE%E5%8D%9AAPI</a></li>
</ul>
<p>实际上我们只关心这个部分：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/20/9MCJo5jusrfbyzA.png" alt="101-24.png"></p>
<p>将 access_token 和 uid 的值填入 <code>./apps/utils/weibo_login.py</code> 的 <code>get_user_info()</code> 函数的形参中。运行得到一个链接，浏览器打开可以看到类似下面的输出：</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> 一个整型<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;idstr&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;class&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;screen_name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;province&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;city&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;location&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;description&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;profile_image_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;light_ring&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;cover_image_phone&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;profile_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;domain&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;weihao&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;gender&quot;</span><span class="punctuation">:</span> <span class="string">&quot;m&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;followers_count&quot;</span><span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;followers_count_str&quot;</span><span class="punctuation">:</span> <span class="string">&quot;2&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;friends_count&quot;</span><span class="punctuation">:</span> 一个整型<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pagefriends_count&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;statuses_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;video_status_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;video_play_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;super_topic_not_syn_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;favourites_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;created_at&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;following&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;allow_all_act_msg&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;geo_enabled&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_type&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;remark&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;insecurity&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;sexual_content&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ptype&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;allow_all_comment&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">true</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avatar_large&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avatar_hd&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_reason&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_trade&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_reason_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_source&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;verified_source_url&quot;</span><span class="punctuation">:</span> <span class="string">&quot;&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;follow_me&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;like&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;like_me&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;online_status&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;bi_followers_count&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;lang&quot;</span><span class="punctuation">:</span> <span class="string">&quot;zh-cn&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;star&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mbtype&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mbrank&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;svip&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vvip&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;mb_expire_time&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;block_word&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;block_app&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;chaohua_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;brand_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;nft_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vplus_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;wenda_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;live_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;gongyi_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;paycolumn_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;newbrand_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;ecommerce_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hardfan_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;wbcolumn_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;interaction_user&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;audio_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;place_ability&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;credit_score&quot;</span><span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user_ability&quot;</span><span class="punctuation">:</span> 一个整型<span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;urank&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;story_read_state&quot;</span><span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;vclub_member&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_teenager&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_guardian&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_teenager_list&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;pc_new&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;special_follow&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">false</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;planet_video&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;video_mark&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;live_status&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;user_ability_extend&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;status_total_counter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;total_cnt&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;repost_cnt&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;comment_cnt&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;like_cnt&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;comment_like_cnt&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;video_total_counter&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;play_cnt&quot;</span><span class="punctuation">:</span> <span class="number">-1</span></span><br><span class="line">  <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;brand_account&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;hongbaofei&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;green_mode&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;urisk&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;unfollowing_recom_switch&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;block&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;block_me&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avatar_type&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_big&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_status&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_realname&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_career&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;auth_career_name&quot;</span><span class="punctuation">:</span> <span class="literal"><span class="keyword">null</span></span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;show_auth&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_auth&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;is_punish&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;avatar_hd_pid&quot;</span><span class="punctuation">:</span> <span class="string">&quot;和谐&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;like_display&quot;</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;comment_display&quot;</span><span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<p>最后要做的就是给用户在我们的应用中注册一个 id，然后和用户的微博 id 绑定。至此实验结束。</p>
<h2 id="开源第三方登录解决方案"><a href="#开源第三方登录解决方案" class="headerlink" title="开源第三方登录解决方案"></a>开源第三方登录解决方案</h2><p>就是文章开头提到的 <a target="_blank" rel="noopener" href="https://github.com/python-social-auth/social-core">social-core</a> .</p>
<p>注意需要：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install social-auth-app-django</span><br></pre></td></tr></table></figure>
<p>然后在 settings 中 INSTALLED_APPS 增加对应内容。</p>
<p>在 settings 中增加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">AUTHENTICATION_BACKENDS = (  <span class="comment"># 只要满足一个即可</span></span><br><span class="line">    <span class="string">&#x27;users.views.CustomBackend&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django.contrib.auth.backends.ModelBackend&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;social_core.backends.weibo.WeiboOAuth2&#x27;</span>,  <span class="comment"># add</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>在全局 urls 中增加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">    re_path(<span class="string">&#x27;&#x27;</span>, include(<span class="string">&#x27;social_django.urls&#x27;</span>, namespace=<span class="string">&#x27;social&#x27;</span>)), <span class="comment"># 第三方登录</span></span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>在全局 settings 中增加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">TEMPLATES = [</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">&#x27;BACKEND&#x27;</span>: <span class="string">&#x27;django.template.backends.django.DjangoTemplates&#x27;</span>,</span><br><span class="line">        <span class="string">&#x27;DIRS&#x27;</span>: [BASE_DIR / <span class="string">&quot;templates&quot;</span>],</span><br><span class="line">        <span class="string">&#x27;APP_DIRS&#x27;</span>: <span class="literal">True</span>,</span><br><span class="line">        <span class="string">&#x27;OPTIONS&#x27;</span>: &#123;</span><br><span class="line">            <span class="string">&#x27;context_processors&#x27;</span>: [</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.debug&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.template.context_processors.request&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.auth.context_processors.auth&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;django.contrib.messages.context_processors.messages&#x27;</span>,</span><br><span class="line">                <span class="string">&#x27;social_django.context_processors.backends&#x27;</span>,  <span class="comment"># add</span></span><br><span class="line">                <span class="string">&#x27;social_django.context_processors.login_redirect&#x27;</span>,  <span class="comment"># add</span></span><br><span class="line">            ],</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SOCIAL_AUTH_WEIBO_KEY = <span class="string">&#x27;和谐&#x27;</span></span><br><span class="line">SOCIAL_AUTH_WEIBO_SECRET = <span class="string">&#x27;和谐&#x27;</span></span><br><span class="line">SOCIAL_AUTH_LOGIN_REDIRECT_URL = <span class="string">&#x27;/index/&#x27;</span></span><br></pre></td></tr></table></figure>
<p>注意跳转到微博那边登录的时候，如果出现错误，可以尝试清空（临时的非安全的）浏览器缓存。</p>
<p>扫码跳转后遇到报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">  File &quot;/home/azureuser/shopvenv/lib/python3.11/site-packages/social_core/utils.py&quot;, line 235, in wrapper</span><br><span class="line">    raise AuthCanceled(args[0], response=err.response)</span><br><span class="line">social_core.exceptions.AuthCanceled: Authentication process canceled</span><br><span class="line">[时间和谐] &quot;GET /complete/weibo/?state=和谐&amp;code=和谐 HTTP/1.1&quot; 500 123165</span><br></pre></td></tr></table></figure>
<p>这（可能？）是由于 social_core 使用 session 认证，和我们的 JWT 不一致，我们复制一份 social_core 到 extra_apps, 然后修改 <code>./extra_apps/social_core/actions.py</code> 源码：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无法确定这段代码是否发挥了我期望它发挥的功能</span></span><br><span class="line"><span class="keyword">from</span> rest_framework_simplejwt.tokens <span class="keyword">import</span> AccessToken</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">do_complete</span>(<span class="params">backend, login, user=<span class="literal">None</span>, redirect_name=<span class="string">&quot;next&quot;</span>, *args, **kwargs</span>):</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> backend.setting(<span class="string">&quot;SANITIZE_REDIRECTS&quot;</span>, <span class="literal">True</span>):</span><br><span class="line">        allowed_hosts = [</span><br><span class="line">            *backend.setting(<span class="string">&quot;ALLOWED_REDIRECT_HOSTS&quot;</span>, []),</span><br><span class="line">            backend.strategy.request_host(),</span><br><span class="line">        ]</span><br><span class="line">        url = sanitize_redirect(allowed_hosts, url) <span class="keyword">or</span> backend.setting(</span><br><span class="line">            <span class="string">&quot;LOGIN_REDIRECT_URL&quot;</span></span><br><span class="line">        )</span><br><span class="line">    response = backend.strategy.redirect(url)</span><br><span class="line">    token = AccessToken.for_user(user)  <span class="comment"># 生成 JWT 访问令牌</span></span><br><span class="line">    response.set_cookie(<span class="string">&quot;name&quot;</span>,user.name <span class="keyword">if</span> user.name <span class="keyword">else</span> user.username,max_age=<span class="number">24</span>*<span class="number">3600</span>)</span><br><span class="line">    response.set_cookie(<span class="string">&quot;token&quot;</span>, <span class="built_in">str</span>(token), max_age=<span class="number">24</span>*<span class="number">3600</span>)</span><br><span class="line">    <span class="keyword">return</span> response</span><br></pre></td></tr></table></figure>
<p>修改 <code>./extra_apps/social_core/backends/oauth.py</code> 中的 <code>validate_state</code> 函数：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 无法确定这个改动是否真的有效。改动的第一天不行，第二天什么都没做就可以正常运行了</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">validate_state</span>(<span class="params">self</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;Validate state value. Raises exception on error, returns state</span></span><br><span class="line"><span class="string">    value if valid.&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> self.STATE_PARAMETER <span class="keyword">and</span> <span class="keyword">not</span> self.REDIRECT_STATE:</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">    <span class="comment"># state = self.get_session_state()</span></span><br><span class="line">    state = self.strategy.request_data().get(<span class="string">&quot;state&quot;</span>)  <span class="comment"># 改为从请求参数获取</span></span><br><span class="line">    request_state = self.get_request_state()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> request_state:</span><br><span class="line">        <span class="keyword">raise</span> AuthMissingParameter(self, <span class="string">&quot;state&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> state:</span><br><span class="line">        <span class="keyword">raise</span> AuthStateMissing(self, <span class="string">&quot;state&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> constant_time_compare(request_state, state):</span><br><span class="line">        <span class="keyword">raise</span> AuthStateForbidden(self)</span><br><span class="line">    <span class="keyword">return</span> state</span><br></pre></td></tr></table></figure>
<h1 id="日志框架-sentry"><a href="#日志框架-sentry" class="headerlink" title="日志框架 sentry"></a>日志框架 sentry</h1><p>注册 sentry 账户: <a target="_blank" rel="noopener" href="https://sentry.io/signup/">https://sentry.io/signup/</a></p>
<p>Install sentry-sdk from PyPI with the django extra:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install --upgrade &#x27;sentry-sdk[django]&#x27;</span><br></pre></td></tr></table></figure>
<p>Initialize the Sentry SDK in your Django settings.py file:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sentry_sdk</span><br><span class="line"></span><br><span class="line">sentry_sdk.init(</span><br><span class="line">    dsn=<span class="string">&quot;https://和谐&quot;</span>,</span><br><span class="line">    <span class="comment"># Add data like request headers and IP for users,</span></span><br><span class="line">    <span class="comment"># see https://docs.sentry.io/platforms/python/data-management/data-collected/ for more info</span></span><br><span class="line">    send_default_pii=<span class="literal">True</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>
<p>You can easily verify your Sentry installation by creating a route that triggers an error:</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.urls <span class="keyword">import</span> path</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">trigger_error</span>(<span class="params">request</span>):</span><br><span class="line">    division_by_zero = <span class="number">1</span> / <span class="number">0</span></span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    path(<span class="string">&#x27;sentry-debug/&#x27;</span>, trigger_error),</span><br><span class="line">    <span class="comment"># ...</span></span><br><span class="line">]</span><br></pre></td></tr></table></figure>
<p>一些相关的文档：<br><a target="_blank" rel="noopener" href="https://docs.sentry.io/platforms/python/integrations/django/">https://docs.sentry.io/platforms/python/integrations/django/</a></p>
<p>引发错误后，可以看到管理界面：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/21/g7aCZlhYbPwfytk.png" alt="101-25.png"></p>
<p>在后端使用 localhost 8000 端口测试时，可以正常收到邮件提醒。</p>
<h1 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h1><p>部署部分的代码和资料，在 github 仓库的分支 deploy_version 上。</p>
<h2 id="安装-nginx"><a href="#安装-nginx" class="headerlink" title="安装 nginx"></a>安装 nginx</h2><p>查看 nginx 是否已经安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">azureuser@2v8g-ubuntu2204:~$ ps -elf|grep nginx</span><br><span class="line">0 S azureus+  129167  129078  0  80   0 -  1752 pipe_r 09:14 pts/0    00:00:00 grep --color=auto nginx</span><br></pre></td></tr></table></figure>
<p>安装：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt install nginx</span><br></pre></td></tr></table></figure>
<p>安装过程中可能需要重启一些服务：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  1. packagekit.service  2. ssh.service  3. none of the above</span><br><span class="line"></span><br><span class="line">(Enter the items or ranges you want to select, separated by spaces.)</span><br><span class="line"></span><br><span class="line">Which services should be restarted?</span><br></pre></td></tr></table></figure>
<p>在提示符下输入 1，然后回车，让 <code>debconf</code> 只重启 <code>packagekit.service</code>，然后手动重启 <code>ssh.service</code>，确保不会影响 SSH 连接。</p>
<h2 id="安装-uwsgi"><a href="#安装-uwsgi" class="headerlink" title="安装 uwsgi"></a>安装 uwsgi</h2><p>在 Auzre 服务器中安装，注意<strong>要</strong>安装到虚拟环境中。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip install uwsgi</span><br></pre></td></tr></table></figure>
<h2 id="开始部署"><a href="#开始部署" class="headerlink" title="开始部署"></a>开始部署</h2><p>注意 settings 文件中的改动。</p>
<p>将 debug 设为 False.</p>
<p>增加：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">STATIC_ROOT = os.path.join(BASE_DIR, <span class="string">&quot;static/&quot;</span>)</span><br></pre></td></tr></table></figure>
<p>将 settings 中的跨域去除。</p>
<p>将前端代码中的端口号去除。</p>
<p>前端代码重新 build, 相关静态资源放入对应的后端文件夹。</p>
<p>执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 manage.py collectstatic</span><br></pre></td></tr></table></figure>
<p>报错：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">SystemCheckError: System check identified some issues:</span><br><span class="line"></span><br><span class="line">ERRORS:</span><br><span class="line">?: (staticfiles.E002) The STATICFILES_DIRS setting should not contain the STATIC_ROOT setting.</span><br></pre></td></tr></table></figure>
<p>相关讨论：<br><a target="_blank" rel="noopener" href="https://www.reddit.com/r/django/comments/1529l15/learning_django/">https://www.reddit.com/r/django/comments/1529l15/learning_django/</a></p>
<blockquote>
<p>You should think of the <code>STATICFILES_DIRS</code> setting as a list of <strong>sources</strong> that <code>collectstatic</code> will scan, and from which it will copy your static files.</p>
<p>You can think of STATIC_ROOT as the <strong>destination</strong> where <code>collectstatic</code> will copy your static files to for serving.</p>
<p>If you list the destination as one of the sources, it would either overwrite your files, or generally make a massive mess, so Django raises an error.</p>
<p>Typically, you would want to set <code>STATIC_ROOT</code> to a directory that a web browser would serve (<code>/srv/http/static/</code> or <code>/var/www/static/</code>) and use Nginx, Apache, etc. to serve them.</p>
<p>Edit: original phrasing sounded too condescending to me, and that was not my intention. Hard to not sound too dry over text sometimes.</p>
</blockquote>
<p>解决方案：</p>
<blockquote>
<p>Just change STATIC_ROOT = BASE_DIR / ‘staticfiles’</p>
</blockquote>
<p>在 settings 中作相关改动即可。</p>
<p>然后把原有的 static 文件夹删除，将 staticfiles 改名为 static.</p>
<p>找到 nginx:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">which nginx</span><br></pre></td></tr></table></figure>
<p>执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo nginx -c /home/azureuser/tiny-shop/mynginx.conf</span><br></pre></td></tr></table></figure>
<p>上面的指令，如果缺少相关文件，创建之；如果有报错，可以丢给 AI.</p>
<p>在虚拟环境中执行：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br></pre></td></tr></table></figure>
<p>查看是否成功：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">azureuser@2v8g-ubuntu2204:~$ ps -elf|grep uwsgi</span><br><span class="line">0 S azureus+  161998  159318  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162000  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162001  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162002  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162003  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162004  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162005  161998  0  80   0 - 19034 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">1 S azureus+  162006  161998  0  80   0 - 62629 ep_pol 07:46 pts/1    00:00:00 uwsgi --ini /home/azureuser/tiny-shop/uwsgi.ini</span><br><span class="line">0 S azureus+  162227  158881  0  80   0 -  1752 pipe_r 07:56 pts/0    00:00:00 grep --color=auto uwsgi</span><br></pre></td></tr></table></figure>
<p>或者在日志中查看亦可。</p>
<p>若发现代码有些错误，需要更改，那么更改之后，就要重新启动 uwsgi.</p>
<p>在云端部署成功：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/23/oZyvDBaxCQ9Xiqr.png" alt="101-26.png"></p>
<p>遗留了一个 bug, 本地运行前后端分离的项目时正常，但是部署到云端缺少 cookie. 尝试了一些方法，没什么思路。这个 bug 会导致在访问网页时的鉴权问题。</p>
<h1 id="杂项及后记"><a href="#杂项及后记" class="headerlink" title="杂项及后记"></a>杂项及后记</h1><p>关于 <code>lookup_field</code>：<br><a target="_blank" rel="noopener" href="https://www.django-rest-framework.org/api-guide/generic-views/#api-reference">https://www.django-rest-framework.org/api-guide/generic-views/#api-reference</a></p>
<p>个人感觉和 fastapi 相比，drf 完全是不同的思路，fastapi 更加直观。drf 除了思路不同，还有很多混乱的地方。</p>
<p>一些 pip install 的东西有点随便，导致开发的时候踩坑。点名 <a target="_blank" rel="noopener" href="https://github.com/jazzband/djangorestframework-simplejwt">djangorestframework-simplejwt</a>，其 github issues 可以看到一些未解决的 bug. 鉴权是个相当麻烦的事情，至少我为了用 JWT 强行上 simplejwt, 同时保留了部分其他认证方式导致了这个局面。</p>
<p>一些让 AI 干活的证据：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/23/VenLC3st1428drJ.png" alt="101-27.png"></p>
<p>16G 内存真的不够用啦：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/03/23/E7mz1T9ICbaJXVN.png" alt="101-28.png"></p>
<p>这还是 debian 勉强能够用，要是 win11 早就炸了。</p>
<p>相比之前实习的项目来说，这种简单的前后端项目，models 和主要的代码逻辑反而是最好写的。但是其他各种各样的细节会淹没人的精力，浪费大量时间，提升却有限，以后还是少接触。</p>
<p>不过也并不是一无所获。在公司实习好像一个流水线上的工人，我只对我负责的那一部分有所了解，其他环节则十分茫然。这种项目反而在一定程度上建立了全局观。</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://dropsong.github.io">dropsong</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://dropsong.github.io/posts/db829e9d.html">https://dropsong.github.io/posts/db829e9d.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://dropsong.github.io" target="_blank">dropsong's</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a><a class="post-meta__tags" href="/tags/docker/">docker</a><a class="post-meta__tags" href="/tags/%E5%90%8E%E7%AB%AF/">后端</a><a class="post-meta__tags" href="/tags/DRF/">DRF</a><a class="post-meta__tags" href="/tags/JWT/">JWT</a><a class="post-meta__tags" href="/tags/CORS/">CORS</a><a class="post-meta__tags" href="/tags/%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8/">云服务器</a><a class="post-meta__tags" href="/tags/API/">API</a><a class="post-meta__tags" href="/tags/vue/">vue</a><a class="post-meta__tags" href="/tags/nginx/">nginx</a><a class="post-meta__tags" href="/tags/uwsgi/">uwsgi</a></div><div class="post_share"><div class="social-share" data-image="https://upload-bbs.miyoushe.com/upload/2024/05/10/225644501/462d472d14c564b3b887d1a958543005_7748922937429727294.jpg" data-sites="facebook,twitter"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://cdn.jsdelivr.net/npm/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://sway.office.com/s/earvb0OKBw38frLT/images/MlKmiZMe5C5Gf5" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sway.office.com/s/earvb0OKBw38frLT/images/MlKmiZMe5C5Gf5" alt="Thanks ᗜ ‸ ᗜ"/></a><div class="post-qr-code-desc">Thanks ᗜ ‸ ᗜ</div></li><li class="reward-item"><a href="https://sway.office.com/s/C4drow041G0kHpIc/images/tO2U2uk1DoetkI" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://sway.office.com/s/C4drow041G0kHpIc/images/tO2U2uk1DoetkI" alt="₍ᐢ.ˬ.⑅ᐢ₎"/></a><div class="post-qr-code-desc">₍ᐢ.ˬ.⑅ᐢ₎</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/posts/60ce6585.html"><img class="prev-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2024/10/18/285958508/948be2308701fbe302fcdd5d7045d43a_8244217296929491053.jpeg" onerror="onerror=null;src='/img/404me.png'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">拉格朗日插值算法实现</div></div></a></div><div class="next-post pull-right"><a href="/posts/821dd720.html"><img class="next-cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/02/17/MDdSmb9Bx8EjlFo.jpg" onerror="onerror=null;src='/img/404me.png'" alt="cover of next post"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">京都、东京游</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/2ab4a7a3.html" title="DRF Note"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/10/31/672384b1ee617.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-31</div><div class="title">DRF Note</div></div></a></div><div><a href="/posts/a9230f8f.html" title="前端入门"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/29/53rbvhJXn4tyaz9.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-09-08</div><div class="title">前端入门</div></div></a></div><div><a href="/posts/b9315374.html" title="实习笔记一"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2024/11/10/6730cce7808a4.png" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-11-10</div><div class="title">实习笔记一</div></div></a></div><div><a href="/posts/7d130280.html" title="Django Note"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/29/LUGFMjCOi68pWNm.webp" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-10-11</div><div class="title">Django Note</div></div></a></div></div></div><hr/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div id="gitalk-container"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="card-widget card-info"><div class="is-center"><div class="avatar-img"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2024/11/07/tEWlYGuVUqFvxw7.png" onerror="this.onerror=null;this.src='/img/friend_404.gif'" alt="avatar"/></div><div class="author-info__name">dropsong</div><div class="author-info__description">把你 TeriTeri 掉哦～(∠・ω< )⌒★</div></div><div class="card-info-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">107</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">164</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">8</div></a></div><a id="card-info-btn" target="_blank" rel="noopener" href="https://github.com/dropsong"><i class="fab fa-github"></i><span>Follow Me</span></a></div><div class="card-widget card-announcement"><div class="item-headline"><i class="fas fa-bullhorn fa-shake"></i><span>公告</span></div><div class="announcement_content">右下设置简繁切换。安卓和 linux 上代码无法正常缩进。图片均有备份，无法加载可联系博主恢复。部分资源需翻墙。</div></div><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%A1%B9%E7%9B%AE%E4%BB%8B%E7%BB%8D"><span class="toc-number">1.</span> <span class="toc-text">项目介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87"><span class="toc-number">2.</span> <span class="toc-text">环境准备</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF"><span class="toc-number">2.1.</span> <span class="toc-text">前端</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%90%8E%E7%AB%AF"><span class="toc-number">2.2.</span> <span class="toc-text">后端</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%AF%BC%E5%85%A5%E6%95%B0%E6%8D%AE"><span class="toc-number">3.</span> <span class="toc-text">导入数据</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#CORS-%E8%B7%A8%E6%BA%90%E8%B5%84%E6%BA%90%E5%85%B1%E4%BA%AB"><span class="toc-number">4.</span> <span class="toc-text">CORS 跨源资源共享</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%94%A8%E6%88%B7%E7%99%BB%E5%BD%95%E5%92%8C%E6%89%8B%E6%9C%BA%E6%B3%A8%E5%86%8C"><span class="toc-number">5.</span> <span class="toc-text">用户登录和手机注册</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Token-%E8%AE%A4%E8%AF%81%E7%99%BB%E5%BD%95"><span class="toc-number">5.1.</span> <span class="toc-text">Token 认证登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#JWT-Token"><span class="toc-number">5.2.</span> <span class="toc-text">JWT Token</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9F%BA%E7%A1%80%E7%9F%A5%E8%AF%86%E5%92%8C%E9%85%8D%E7%BD%AE"><span class="toc-number">5.2.1.</span> <span class="toc-text">基础知识和配置</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C-access-%E5%92%8C-refresh"><span class="toc-number">5.2.2.</span> <span class="toc-text">实验 - access 和 refresh</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C-Sliding-Token"><span class="toc-number">5.2.3.</span> <span class="toc-text">实验 - Sliding Token</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E6%9C%BA%E5%8F%B7%E7%99%BB%E5%BD%95"><span class="toc-number">5.3.</span> <span class="toc-text">手机号登录</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%89%8B%E6%9C%BA%E5%8F%B7%E6%B3%A8%E5%86%8C"><span class="toc-number">5.4.</span> <span class="toc-text">手机号注册</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5-%E6%96%87%E6%A1%A3%E7%94%9F%E6%88%90"><span class="toc-number">6.</span> <span class="toc-text">问题排查-文档生成</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E6%8E%92%E6%9F%A5-%E8%AE%A4%E8%AF%81"><span class="toc-number">7.</span> <span class="toc-text">问题排查-认证</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Azure-%E4%BA%91%E6%9C%8D%E5%8A%A1%E5%99%A8"><span class="toc-number">8.</span> <span class="toc-text">Azure 云服务器</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%8D%E5%8A%A1%E5%99%A8%E7%9B%B8%E5%85%B3"><span class="toc-number">8.1.</span> <span class="toc-text">服务器相关</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8-docker"><span class="toc-number">8.2.</span> <span class="toc-text">使用 docker</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%94%AF%E4%BB%98%E5%AE%9D%E6%94%AF%E4%BB%98"><span class="toc-number">9.</span> <span class="toc-text">支付宝支付</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%89%8D%E7%AB%AF%E9%83%A8%E7%BD%B2"><span class="toc-number">10.</span> <span class="toc-text">前端部署</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%BC%93%E5%AD%98"><span class="toc-number">11.</span> <span class="toc-text">缓存</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95"><span class="toc-number">12.</span> <span class="toc-text">第三方登录</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%9E%E9%AA%8C"><span class="toc-number">12.1.</span> <span class="toc-text">实验</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E6%BA%90%E7%AC%AC%E4%B8%89%E6%96%B9%E7%99%BB%E5%BD%95%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88"><span class="toc-number">12.2.</span> <span class="toc-text">开源第三方登录解决方案</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%97%A5%E5%BF%97%E6%A1%86%E6%9E%B6-sentry"><span class="toc-number">13.</span> <span class="toc-text">日志框架 sentry</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2"><span class="toc-number">14.</span> <span class="toc-text">部署</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-nginx"><span class="toc-number">14.1.</span> <span class="toc-text">安装 nginx</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%AE%89%E8%A3%85-uwsgi"><span class="toc-number">14.2.</span> <span class="toc-text">安装 uwsgi</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%80%E5%A7%8B%E9%83%A8%E7%BD%B2"><span class="toc-number">14.3.</span> <span class="toc-text">开始部署</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9D%82%E9%A1%B9%E5%8F%8A%E5%90%8E%E8%AE%B0"><span class="toc-number">15.</span> <span class="toc-text">杂项及后记</span></a></li></ol></div></div><div class="card-widget card-recent-post"><div class="item-headline"><i class="fas fa-history"></i><span>最新文章</span></div><div class="aside-list"><div class="aside-list-item"><a class="thumbnail" href="/posts/e4a2e80.html" title="有用的 prompt"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://bu.dusays.com/2025/07/09/686e8e76993cc.png" onerror="this.onerror=null;this.src='/img/404me.png'" alt="有用的 prompt"/></a><div class="content"><a class="title" href="/posts/e4a2e80.html" title="有用的 prompt">有用的 prompt</a><time datetime="2025-07-09T15:35:28.000Z" title="发表于 2025-07-09 23:35:28">2025-07-09</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/eeca0305.html" title="深度学习小记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/05/16/4BTsNnSgIPFewCh.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="深度学习小记"/></a><div class="content"><a class="title" href="/posts/eeca0305.html" title="深度学习小记">深度学习小记</a><time datetime="2025-05-16T06:57:13.000Z" title="发表于 2025-05-16 14:57:13">2025-05-16</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/ffce18f.html" title="win + debian 双系统"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/05/10/1MoBUm7KaexdWg5.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="win + debian 双系统"/></a><div class="content"><a class="title" href="/posts/ffce18f.html" title="win + debian 双系统">win + debian 双系统</a><time datetime="2025-05-10T13:16:59.000Z" title="发表于 2025-05-10 21:16:59">2025-05-10</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/5888fb8e.html" title="微积分补完计划"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://upload-bbs.miyoushe.com/upload/2025/01/26/75276539/18ac78490f43bf9da7f8c453a59555b5_2308110768772033072.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="微积分补完计划"/></a><div class="content"><a class="title" href="/posts/5888fb8e.html" title="微积分补完计划">微积分补完计划</a><time datetime="2025-05-01T15:17:43.000Z" title="发表于 2025-05-01 23:17:43">2025-05-01</time></div></div><div class="aside-list-item"><a class="thumbnail" href="/posts/b1b54fd.html" title="机器学习笔记"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://s2.loli.net/2025/04/01/uzqBjab1yZW9HLU.jpg" onerror="this.onerror=null;this.src='/img/404me.png'" alt="机器学习笔记"/></a><div class="content"><a class="title" href="/posts/b1b54fd.html" title="机器学习笔记">机器学习笔记</a><time datetime="2025-04-01T07:38:47.000Z" title="发表于 2025-04-01 15:38:47">2025-04-01</time></div></div></div></div></div></div></main><footer id="footer"><div id="footer-wrap"><div class="copyright">&copy;2022 - 2025 By dropsong</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></div><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div id="local-search-results"></div></div></div><div id="search-mask"></div></div><div><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui/dist/fancybox.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="/js/search/local-search.js"></script><div class="js-pjax"><script>function addGitalkSource () {
  const ele = document.createElement('link')
  ele.rel = 'stylesheet'
  ele.href= 'https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.css'
  document.getElementsByTagName('head')[0].appendChild(ele)
}

function loadGitalk () {
  function initGitalk () {
    var gitalk = new Gitalk(Object.assign({
      clientID: 'Ov23lijmGQilj9J9CrdP',
      clientSecret: '255f80b6a1783219f05a3c250856e45342d37c3b',
      repo: 'dropsong.github.io',
      owner: 'dropsong',
      admin: ['dropsong'],
      id: 'a1934fedb6d7ebc25e6bb2e01e66d3c1',
      updateCountCallback: commentCount
    },null))

    gitalk.render('gitalk-container')
  }

  if (typeof Gitalk === 'function') initGitalk()
  else {
    addGitalkSource()
    getScript('https://cdn.jsdelivr.net/npm/gitalk/dist/gitalk.min.js').then(initGitalk)
  }
}

function commentCount(n){
  let isCommentCount = document.querySelector('#post-meta .gitalk-comment-count')
  if (isCommentCount) {
    isCommentCount.innerHTML= n
  }
}

if ('Gitalk' === 'Gitalk' || !false) {
  if (false) btf.loadComment(document.getElementById('gitalk-container'), loadGitalk)
  else loadGitalk()
} else {
  function loadOtherComment () {
    loadGitalk()
  }
}</script></div><script src="https://cdn.jsdelivr.net/npm/pjax/pjax.min.js"></script><script>let pjaxSelectors = ["head > title","#config-diff","#body-wrap","#rightside-config-hide","#rightside-config-show",".js-pjax"]

var pjax = new Pjax({
  elements: 'a:not([target="_blank"])',
  selectors: pjaxSelectors,
  cacheBust: false,
  analytics: false,
  scrollRestoration: false
})

document.addEventListener('pjax:send', function () {

  // removeEventListener scroll 
  window.tocScrollFn && window.removeEventListener('scroll', window.tocScrollFn)
  window.scrollCollect && window.removeEventListener('scroll', scrollCollect)

  typeof preloader === 'object' && preloader.initLoading()
  document.getElementById('rightside').style.cssText = "opacity: ''; transform: ''"
  
  if (window.aplayers) {
    for (let i = 0; i < window.aplayers.length; i++) {
      if (!window.aplayers[i].options.fixed) {
        window.aplayers[i].destroy()
      }
    }
  }

  typeof typed === 'object' && typed.destroy()

  //reset readmode
  const $bodyClassList = document.body.classList
  $bodyClassList.contains('read-mode') && $bodyClassList.remove('read-mode')

  typeof disqusjs === 'object' && disqusjs.destroy()
})

document.addEventListener('pjax:complete', function () {
  window.refreshFn()

  document.querySelectorAll('script[data-pjax]').forEach(item => {
    const newScript = document.createElement('script')
    const content = item.text || item.textContent || item.innerHTML || ""
    Array.from(item.attributes).forEach(attr => newScript.setAttribute(attr.name, attr.value))
    newScript.appendChild(document.createTextNode(content))
    item.parentNode.replaceChild(newScript, item)
  })

  GLOBAL_CONFIG.islazyload && window.lazyLoadInstance.update()

  typeof chatBtnFn === 'function' && chatBtnFn()
  typeof panguInit === 'function' && panguInit()

  // google analytics
  typeof gtag === 'function' && gtag('config', '', {'page_path': window.location.pathname});

  // baidu analytics
  typeof _hmt === 'object' && _hmt.push(['_trackPageview',window.location.pathname]);

  typeof loadMeting === 'function' && document.getElementsByClassName('aplayer').length && loadMeting()

  // prismjs
  typeof Prism === 'object' && Prism.highlightAll()

  typeof preloader === 'object' && preloader.endLoading()
})

document.addEventListener('pjax:error', (e) => {
  if (e.request.status === 404) {
    pjax.loadUrl('/404.html')
  }
})</script></div><!-- hexo injector body_end start --><script async src="/js/ali_font.js"></script><!-- hexo injector body_end end --></body></html>